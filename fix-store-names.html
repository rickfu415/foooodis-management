<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>修复店铺名称 - 食圈儿后台管理系统</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        min-height: 100vh;
        padding: 20px;
      }

      .header {
        background-color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 20px;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
      }

      .btn-back {
        background-color: #6c757d;
        color: white;
      }

      .btn-primary {
        background-color: #007bff;
        color: white;
      }

      .progress-container {
        margin: 20px 0;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
      }

      .progress {
        width: 0%;
        height: 100%;
        background-color: #007bff;
        transition: width 0.3s ease;
      }

      .log-container {
        margin-top: 20px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 4px;
        max-height: 400px;
        overflow-y: auto;
      }

      .log-entry {
        margin: 5px 0;
        padding: 5px;
        border-bottom: 1px solid #eee;
      }

      .success {
        color: #28a745;
      }

      .error {
        color: #dc3545;
      }

      .warning {
        color: #ffc107;
      }

      .input-group {
        margin: 20px 0;
      }

      .form-control {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .card {
        margin-bottom: 20px;
      }

      .card h2 {
        margin-bottom: 15px;
        color: #333;
      }

      .filter-group {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .filter-input {
        padding: 6px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .pagination {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .btn-sm {
        padding: 4px 8px;
        font-size: 12px;
      }
      th {
        cursor: pointer;
        user-select: none;
      }
      th:hover {
        background-color: #f0f0f0;
      }

      .import-logs {
        max-height: 400px;
        overflow-y: auto;
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        font-family: monospace;
        white-space: pre-wrap;
      }
      .log-entry {
        margin: 2px 0;
        padding: 2px 0;
        border-bottom: 1px solid #eee;
      }
      .log-stats {
        color: #0066cc;
        font-weight: bold;
      }
      .log-warning {
        color: #cc6600;
      }
      .log-error {
        color: #cc0000;
      }

      .card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .card h4 {
        margin-bottom: 15px;
        color: #333;
        font-size: 18px;
      }

      .button-group {
        margin: 15px 0;
        display: flex;
        gap: 10px;
      }

      .import-logs {
        margin-top: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
        max-height: 400px;
        overflow-y: auto;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .btn-primary {
        background-color: #007bff;
        color: white;
      }

      .btn-success {
        background-color: #28a745;
        color: white;
      }

      .form-control {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px;
      }

      .log-item {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
        background: #f8f9fa;
        border-left: 4px solid #ddd;
      }

      .log-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-size: 12px;
        color: #666;
      }

      .log-content {
        font-size: 14px;
        color: #333;
      }

      .log-type {
        font-weight: bold;
      }

      .log-fix {
        border-left-color: #007bff;
      }

      .log-extract {
        border-left-color: #28a745;
      }

      .log-inventory {
        border-left-color: #fd7e14;
      }

      .log-time {
        color: #888;
      }

      .log-operator {
        color: #666;
        font-weight: bold;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
  </head>
  <body>
    <header class="header">
      <div>
        <a href="admin-panel.html" class="btn btn-back">返回管理面板</a>
      </div>
      <div class="user-info">
        <span id="adminName">管理员</span>
      </div>
    </header>

    <div class="container">
      <div class="card">
        <h2>修复历史盘点记录的店铺名称</h2>

        <div class="progress-container">
          <div class="progress-bar">
            <div id="progressBar" class="progress"></div>
          </div>
          <div id="progressText" style="text-align: center; margin-top: 10px">
            准备开始...
          </div>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 20px">
          <button
            id="createStoreClassBtn"
            class="btn btn-primary"
            onclick="createStoreClass()"
          >
            创建Store Class
          </button>
          <button id="startButton" class="btn btn-primary" onclick="startFix()">
            开始修复
          </button>
          <button
            id="importSalesButton"
            class="btn btn-primary"
            onclick="importHistoricalSales()"
          >
            导入历史销售数据
          </button>
        </div>

        <div class="log-container" id="logContainer">
          <!-- 日志将在这里显示 -->
        </div>
      </div>

      <div class="card">
        <h2>导入历史销售数据</h2>

        <div style="display: flex; gap: 10px; margin-bottom: 20px">
          <button
            id="createDailyProductSalesClassBtn"
            class="btn btn-primary"
            onclick="createDailyProductSalesClass()"
          >
            创建 DailyProductSales Class
          </button>
        </div>

        <div class="input-group" style="margin: 20px 0">
          <label
            for="salesFolderPath"
            style="display: block; margin-bottom: 10px"
            >数据文件夹路径：</label
          >
          <div style="display: flex; gap: 10px">
            <input
              type="text"
              id="salesFolderPath"
              class="form-control"
              style="
                flex: 1;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
              "
              placeholder="例如：F:/Dropbox/LifeCoreValue/ChengduSubway/Model/foooodis/data/sales/"
            />
            <button class="btn btn-primary" onclick="scanSalesFolder()">
              扫描文件夹
            </button>
          </div>
        </div>

        <div class="input-group" style="margin: 20px 0">
          <label for="salesDataPath" style="display: block; margin-bottom: 10px"
            >单个文件导入：</label
          >
          <div style="display: flex; gap: 10px">
            <input
              type="text"
              id="salesDataPath"
              class="form-control"
              style="
                flex: 1;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
              "
              placeholder="例如：F:/Dropbox/LifeCoreValue/ChengduSubway/Model/foooodis/data/sales_2024_03.xlsx"
            />
            <button class="btn btn-primary" onclick="loadSalesFile()">
              加载文件
            </button>
          </div>
        </div>

        <div class="progress-container">
          <div class="progress-bar">
            <div id="salesProgressBar" class="progress"></div>
          </div>
          <div
            id="salesProgressText"
            style="text-align: center; margin-top: 10px"
          >
            等待操作...
          </div>
        </div>

        <div class="log-container" id="salesLogContainer">
          <!-- 销售数据导入日志将在这里显示 -->
        </div>
      </div>

      <!-- 商品管理卡片 -->
      <div class="card">
        <h2>商品管理</h2>
        <div style="margin-bottom: 20px">
          <button
            id="createProductClassBtn"
            class="btn btn-primary"
            onclick="createProductClass()"
          >
            创建 Product Class
          </button>
          <button class="btn btn-primary" onclick="extractAndUpdateProducts()">
            从销售数据提取商品
          </button>
        </div>

        <!-- 商品列表表格 -->
        <div class="table-container">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
            "
          >
            <div class="filter-group">
              <select
                id="categoryFilter"
                class="filter-input"
                onchange="filterProducts()"
              >
                <option value="all">所有类别</option>
                <option value="main_dish">主食类</option>
                <option value="snack">小吃类</option>
                <option value="drink">饮品类</option>
                <option value="bakery">烘焙类</option>
              </select>
              <select
                id="sourceFilter"
                class="filter-input"
                onchange="filterProducts()"
              >
                <option value="all">所有来源</option>
                <option value="self_made">自制</option>
                <option value="purchased">外采</option>
              </select>
              <input
                type="text"
                id="searchInput"
                class="filter-input"
                placeholder="搜索商品名称..."
                oninput="filterProducts()"
              />
            </div>
            <div class="pagination">
              <span>每页显示：</span>
              <select
                id="pageSize"
                class="filter-input"
                onchange="updatePageSize()"
              >
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th onclick="sortProducts('name')">
                  商品名称 <span id="sortName"></span>
                </th>
                <th onclick="sortProducts('category')">
                  类型 <span id="sortCategory"></span>
                </th>
                <th onclick="sortProducts('source')">
                  来源 <span id="sortSource"></span>
                </th>
                <th onclick="sortProducts('price')">
                  单价 <span id="sortPrice"></span>
                </th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="productsTable">
              <!-- 商品列表将通过 JavaScript 动态生成 -->
            </tbody>
          </table>

          <div class="pagination" style="margin-top: 10px">
            <button class="btn btn-sm" onclick="previousPage()">
              &lt; 上一页
            </button>
            <span id="pageInfo">第 1 页，共 1 页</span>
            <button class="btn btn-sm" onclick="nextPage()">下一页 &gt;</button>
          </div>
        </div>

        <div class="log-container" id="productLogContainer">
          <!-- 商品管理日志将在这里显示 -->
        </div>
      </div>

      <!-- 导入盘点数据卡片 -->
      <div class="card">
        <h2>导入盘点数据</h2>
        <div class="form-group">
          <label>选择盘点数据文件</label>
          <input
            type="file"
            id="inventoryFile"
            accept=".xlsx,.xls"
            class="form-control"
            style="margin-bottom: 10px"
          />
        </div>
        <div class="button-group">
          <button class="btn btn-primary" onclick="importInventoryData()">
            导入数据
          </button>
        </div>
        <div
          id="importStatus"
          class="log-container"
          style="margin-top: 10px"
        ></div>
      </div>

      <!-- 商品来源修改 -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">批量修改商品来源</h2>
        </div>
        <div class="table-container">
          <div class="filter-group">
            <select
              id="categoryFilter"
              class="filter-input"
              onchange="filterProducts()"
            >
              <option value="all">所有类别</option>
              <option value="饮品类">饮品类</option>
              <option value="烘焙类">烘焙类</option>
              <option value="港式点心">港式点心</option>
              <option value="材料">材料</option>
            </select>
            <input
              type="text"
              id="searchInput"
              class="filter-input"
              placeholder="搜索商品名称..."
              oninput="filterProducts()"
            />
            <button class="btn btn-primary" onclick="updateSelectedSources()">
              更新选中商品来源
            </button>
          </div>
          <table>
            <thead>
              <tr>
                <th>
                  <input
                    type="checkbox"
                    id="selectAll"
                    onchange="toggleSelectAll()"
                  />
                </th>
                <th>商品名称</th>
                <th>类别</th>
                <th>当前来源</th>
                <th>新来源</th>
              </tr>
            </thead>
            <tbody id="productList">
              <!-- 商品列表将通过JavaScript动态生成 -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- 销售数据店铺名称修改 -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">批量修改销售数据店铺名称</h2>
        </div>
        <div class="table-container">
          <div class="description" style="margin-bottom: 15px">
            此功能将移除销售数据中店铺名称的品牌前缀（如"食圈儿 "）
          </div>
          <button class="btn btn-primary" onclick="updateStoreNames()">
            开始批量修改店铺名称
          </button>
          <div
            id="updateStatus"
            class="log-container"
            style="margin-top: 15px"
          ></div>
        </div>
      </div>

      <script>
        // 初始化 LeanCloud
        AV.init({
          appId: "mkIfcbivpuTduCrNfh53VqYV-MdYXbMMI",
          appKey: "e4T5MriHgEYtmK7YPvV64awF",
          serverURL: "https://mkifcbivputducrnfh53vqyv.api.lncldglobal.com",
        });

        // 检查管理员权限
        async function checkAdmin() {
          const currentUser = AV.User.current();
          if (!currentUser) {
            window.location.href = "index.html";
            return;
          }

          const userData = JSON.parse(localStorage.getItem("user"));
          if (userData.role !== "admin") {
            alert("您没有访问此页面的权限");
            window.location.href = "select-store.html";
            return;
          }

          document.getElementById("adminName").textContent = userData.name;
        }

        // 添加日志
        function addLog(message, type = "") {
          const logContainer = document.getElementById("logContainer");
          const logEntry = document.createElement("div");
          logEntry.className = `log-entry ${type}`;
          logEntry.textContent = message;
          logContainer.insertBefore(logEntry, logContainer.firstChild);
        }

        // 更新进度
        function updateProgress(current, total) {
          const percentage = (current / total) * 100;
          document.getElementById("progressBar").style.width = percentage + "%";
          document.getElementById(
            "progressText"
          ).textContent = `处理进度: ${current}/${total} (${percentage.toFixed(
            1
          )}%)`;
        }

        // 开始修复
        async function startFix() {
          try {
            // 禁用开始按钮
            document.getElementById("startButton").disabled = true;
            addLog("开始修复流程...");

            // 获取所有店铺信息
            const stores =
              window.stores || JSON.parse(localStorage.getItem("stores"));
            if (!stores) {
              throw new Error("无法获取店铺信息");
            }

            // 创建店铺ID到名称的映射
            const storeMap = {};
            Object.entries(stores).forEach(([type, storeList]) => {
              storeList.forEach((store) => {
                storeMap[store.id] = `${store.brand} ${store.name}`;
              });
            });

            // 查询所有没有店铺名称的盘点记录
            const query = new AV.Query("InventoryCheck");
            query.doesNotExist("storeName");
            query.limit(1000); // 最大限制
            const records = await query.find();

            addLog(`找到 ${records.length} 条需要修复的记录`);

            let successCount = 0;
            let errorCount = 0;

            // 更新每条记录
            for (let i = 0; i < records.length; i++) {
              const record = records[i];
              try {
                const storeId = record.get("storeId");
                if (storeId && storeMap[storeId]) {
                  record.set("storeName", storeMap[storeId]);
                  await record.save();
                  addLog(
                    `成功更新记录 ${record.id}，店铺名称: ${storeMap[storeId]}`,
                    "success"
                  );
                  successCount++;
                } else {
                  addLog(`记录 ${record.id} 缺少有效的店铺ID`, "warning");
                  errorCount++;
                }
              } catch (error) {
                addLog(`更新记录 ${record.id} 失败: ${error.message}`, "error");
                errorCount++;
              }

              updateProgress(i + 1, records.length);
            }

            // 显示最终结果
            addLog(
              `修复完成！成功: ${successCount}, 失败: ${errorCount}`,
              successCount > 0 ? "success" : "error"
            );
          } catch (error) {
            addLog(`发生错误: ${error.message}`, "error");
          } finally {
            // 重新启用开始按钮
            document.getElementById("startButton").disabled = false;
          }
        }

        // 创建 Store Class
        async function createStoreClass() {
          try {
            document.getElementById("createStoreClassBtn").disabled = true;
            addLog("开始创建 Store Class...");

            // 获取所有店铺信息
            const stores =
              window.stores || JSON.parse(localStorage.getItem("stores"));
            if (!stores) {
              throw new Error("无法获取店铺信息");
            }

            // 创建 Store class
            const Store = AV.Object.extend("Store");

            // 先创建一个临时对象并保存，这样会自动创建 class
            const tempStore = new Store();
            tempStore.set("temp", true);
            await tempStore.save();
            await tempStore.destroy();
            addLog("Store Class 创建成功");

            // 查询现有数据
            const query = new AV.Query("Store");
            const existingStores = await query.find();

            // 删除现有的店铺数据
            if (existingStores.length > 0) {
              addLog(`删除 ${existingStores.length} 条现有店铺数据...`);
              for (const store of existingStores) {
                await store.destroy();
              }
            }

            // 同步直营店数据
            addLog(`开始同步 ${stores.direct.length} 家直营店数据...`);
            for (const store of stores.direct) {
              const storeObj = new Store();
              storeObj.set("storeId", store.id);
              storeObj.set("brand", "食圈儿");
              storeObj.set("name", store.name);
              storeObj.set("type", "direct");
              storeObj.set("address", store.address);
              storeObj.set("status", store.status || "open");
              await storeObj.save();
              addLog(`已同步直营店: ${store.name}`, "success");
            }

            // 同步加盟店数据
            addLog(`开始同步 ${stores.franchise.length} 家加盟店数据...`);
            for (const store of stores.franchise) {
              const storeObj = new Store();
              storeObj.set("storeId", store.id);
              storeObj.set("brand", "食圈儿");
              storeObj.set("name", store.name);
              storeObj.set("type", "franchise");
              storeObj.set("address", store.address);
              storeObj.set("status", store.status || "open");
              await storeObj.save();
              addLog(`已同步加盟店: ${store.name}`, "success");
            }

            addLog("Store Class 创建和数据同步完成！", "success");
          } catch (error) {
            console.error("创建 Store Class 失败:", error);
            addLog(`创建失败: ${error.message}`, "error");
          } finally {
            document.getElementById("createStoreClassBtn").disabled = false;
          }
        }

        // 导入历史销售数据
        async function importHistoricalSales() {
          try {
            document.getElementById("importSalesButton").disabled = true;
            addLog("开始导入历史销售数据...");

            // 读取历史数据文件夹中的文件
            const response = await fetch("db/historical_sales/");
            if (!response.ok) {
              throw new Error("无法访问历史数据文件夹");
            }

            const files = await response.json();
            addLog(`找到 ${files.length} 个数据文件`);

            // 创建 DailyProductSales class
            const DailyProductSales = AV.Object.extend("DailyProductSales");

            // 遍历每个文件
            for (const file of files) {
              try {
                const fileResponse = await fetch(`db/historical_sales/${file}`);
                const salesData = await fileResponse.json();

                addLog(`处理文件: ${file}`);

                // 解析文件名中的日期和店铺信息
                const [date, storeName] = file.replace(".json", "").split("_");
                const salesDate = new Date(date);

                // 检查是否已存在该日期和店铺的数据
                const query = new AV.Query("DailyProductSales");
                query.equalTo("date", salesDate);
                query.equalTo("storeName", `食圈儿 ${storeName}`);
                const existingData = await query.find();

                // 如果已存在数据，则跳过
                if (existingData.length > 0) {
                  addLog(`${date} ${storeName} 的数据已存在，跳过`, "warning");
                  continue;
                }

                // 导入数据
                for (const item of salesData) {
                  const sale = new DailyProductSales();
                  sale.set("date", salesDate);
                  sale.set("storeName", `食圈儿 ${storeName}`);
                  sale.set("productName", item.productName);
                  sale.set("category", item.category);
                  sale.set("source", item.source);
                  sale.set("quantity", item.quantity);
                  sale.set("price", item.price);
                  await sale.save();
                }

                addLog(
                  `成功导入 ${salesData.length} 条数据: ${date} ${storeName}`,
                  "success"
                );
              } catch (error) {
                addLog(`处理文件 ${file} 失败: ${error.message}`, "error");
              }
            }

            addLog("历史销售数据导入完成！", "success");
          } catch (error) {
            console.error("导入历史销售数据失败:", error);
            addLog(`导入失败: ${error.message}`, "error");
          } finally {
            document.getElementById("importSalesButton").disabled = false;
          }
        }

        // 添加销售日志
        function addSalesLog(message, type = "") {
          const logContainer = document.getElementById("salesLogContainer");
          const logEntry = document.createElement("div");
          logEntry.className = `log-entry ${type}`;
          logEntry.textContent = message;
          logContainer.insertBefore(logEntry, logContainer.firstChild);
        }

        // 更新销售导入进度
        function updateSalesProgress(current, total) {
          const percentage = (current / total) * 100;
          document.getElementById("salesProgressBar").style.width =
            percentage + "%";
          document.getElementById(
            "salesProgressText"
          ).textContent = `处理进度: ${current}/${total} (${percentage.toFixed(
            1
          )}%)`;
        }

        // 加载并处理销售数据文件
        async function loadSalesFile() {
          try {
            const fileInput = document.createElement("input");
            fileInput.type = "file";
            fileInput.accept = ".xlsx,.xls";
            fileInput.onchange = async function (e) {
              try {
                const file = e.target.files[0];
                addSalesLog(`开始处理文件: ${file.name}`);

                // 使用 XLSX 读取文件
                const data = await readExcelFile(file);
                if (data && data.length > 0) {
                  await importSalesData(data);
                  addSalesLog(`文件处理完成: ${file.name}`, "success");
                } else {
                  addSalesLog(
                    `文件中没有找到有效数据: ${file.name}`,
                    "warning"
                  );
                }
              } catch (error) {
                addSalesLog(`处理文件失败: ${error.message}`, "error");
              }
            };

            fileInput.click();
          } catch (error) {
            addSalesLog(`加载文件失败: ${error.message}`, "error");
          }
        }

        // 导入销售数据
        async function importSalesData(salesData) {
          try {
            addSalesLog("开始导入数据到 LeanCloud...");

            // 确保 DailyProductSales class 存在
            const DailyProductSales = AV.Object.extend("DailyProductSales");

            // 尝试查询，如果失败则创建 class
            try {
              const query = new AV.Query("DailyProductSales");
              await query.first();
            } catch (error) {
              if (error.code === 404) {
                const created = await createDailyProductSalesClass();
                if (!created) {
                  throw new Error("无法创建 DailyProductSales Class");
                }
              }
            }

            let successCount = 0;
            let errorCount = 0;
            const batchSize = 100; // 每批处理100条记录
            const batches = [];

            // 将数据分批
            for (let i = 0; i < salesData.length; i += batchSize) {
              batches.push(salesData.slice(i, i + batchSize));
            }

            addSalesLog(
              `将分 ${batches.length} 批处理数据，每批 ${batchSize} 条`
            );

            // 处理每一批数据
            for (
              let batchIndex = 0;
              batchIndex < batches.length;
              batchIndex++
            ) {
              const batch = batches[batchIndex];
              const batchObjects = [];
              const existingRecords = new Set();

              // 先批量查询已存在的记录
              const queries = batch.map((item) => {
                const query = new AV.Query("DailyProductSales");
                query.equalTo("date", new Date(item.date));
                query.equalTo("storeName", item.storeName);
                query.equalTo("productName", item.productName);
                return query;
              });

              const compositeQuery = AV.Query.or(...queries);
              const existing = await compositeQuery.find();

              // 记录已存在的记录标识
              existing.forEach((record) => {
                const key = `${record.get("date").toISOString()}_${record.get(
                  "storeName"
                )}_${record.get("productName")}`;
                existingRecords.add(key);
              });

              // 创建新记录
              for (const item of batch) {
                const key = `${new Date(item.date).toISOString()}_${
                  item.storeName
                }_${item.productName}`;
                if (!existingRecords.has(key)) {
                  const sale = new DailyProductSales();
                  sale.set("date", new Date(item.date));
                  sale.set("storeName", item.storeName);
                  sale.set("productName", item.productName);
                  sale.set("category", item.category);
                  sale.set("source", item.source);
                  sale.set("quantity", item.quantity);
                  sale.set("price", item.price);
                  batchObjects.push(sale);
                } else {
                  addSalesLog(
                    `跳过重复记录: ${item.date} ${item.storeName} ${item.productName}`,
                    "warning"
                  );
                }
              }

              if (batchObjects.length > 0) {
                try {
                  await AV.Object.saveAll(batchObjects);
                  successCount += batchObjects.length;
                  addSalesLog(
                    `成功导入第 ${batchIndex + 1}/${
                      batches.length
                    } 批数据，本批导入 ${batchObjects.length} 条记录`,
                    "success"
                  );
                } catch (error) {
                  errorCount += batchObjects.length;
                  addSalesLog(`批量导入失败: ${error.message}`, "error");
                }
              }

              // 更新进度
              updateSalesProgress(
                Math.min((batchIndex + 1) * batchSize, salesData.length),
                salesData.length
              );
            }

            addSalesLog(
              `导入完成！成功: ${successCount}, 失败: ${errorCount}`,
              successCount > 0 ? "success" : "error"
            );
          } catch (error) {
            addSalesLog(`导入过程发生错误: ${error.message}`, "error");
          }
        }

        // 扫描销售数据文件夹
        async function scanSalesFolder() {
          try {
            // 创建文件夹选择器
            const folderInput = document.createElement("input");
            folderInput.type = "file";
            folderInput.webkitdirectory = true;
            folderInput.multiple = true;

            folderInput.onchange = async function (e) {
              try {
                const files = Array.from(e.target.files).filter(
                  (file) =>
                    file.name.endsWith(".xlsx") || file.name.endsWith(".xls")
                );

                if (files.length === 0) {
                  addSalesLog("未找到Excel文件", "warning");
                  return;
                }

                addSalesLog(`找到 ${files.length} 个Excel文件，开始处理...`);

                // 按文件名排序（假设文件名包含日期）
                files.sort((a, b) => a.name.localeCompare(b.name));

                let successCount = 0;
                let errorCount = 0;

                for (let i = 0; i < files.length; i++) {
                  try {
                    const file = files[i];
                    addSalesLog(
                      `处理文件 ${i + 1}/${files.length}: ${file.name}`
                    );

                    // 使用 XLSX 库读取 Excel 文件
                    const data = await readExcelFile(file);
                    if (data && data.length > 0) {
                      await importSalesData(data);
                      successCount++;
                    }

                    // 更新总进度
                    updateSalesProgress(i + 1, files.length);
                  } catch (error) {
                    errorCount++;
                    addSalesLog(
                      `处理文件 ${files[i].name} 失败: ${error.message}`,
                      "error"
                    );
                  }
                }

                addSalesLog(
                  `所有文件处理完成！成功: ${successCount}, 失败: ${errorCount}`,
                  successCount > 0 ? "success" : "error"
                );
              } catch (error) {
                addSalesLog(`扫描文件夹失败: ${error.message}`, "error");
              }
            };

            folderInput.click();
          } catch (error) {
            addSalesLog(`选择文件夹失败: ${error.message}`, "error");
          }
        }

        // 读取Excel文件
        async function readExcelFile(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = function (e) {
              try {
                const data = e.target.result;
                const workbook = XLSX.read(data, { type: "array" });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                // 将 Excel 数据转换为对象数组
                const rawData = XLSX.utils.sheet_to_json(worksheet);

                // 处理数据，使用英文列名
                const processedData = rawData.map((row) => ({
                  date: row["Date"] || "",
                  storeName: `食圈儿 ${row["Store"] || ""}`,
                  productName: row["Product"] || "",
                  category: mapCategory(row["Category"] || ""),
                  source: mapSource(row["Source"] || ""),
                  quantity: parseInt(row["Sale"] || 0),
                  price: parseFloat(row["Price"] || 0),
                }));

                resolve(processedData);
              } catch (error) {
                reject(error);
              }
            };
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
          });
        }

        // 映射类型
        function mapCategory(rawCategory) {
          const categoryMap = {
            主食: "main_dish",
            小吃: "snack",
            饮品: "drink",
            "Main Dish": "main_dish",
            Snack: "snack",
            Drink: "drink",
          };
          return categoryMap[rawCategory] || rawCategory.toLowerCase();
        }

        // 映射来源
        function mapSource(rawSource) {
          const sourceMap = {
            自制: "self_made",
            外采: "purchased",
            "Self Made": "self_made",
            Purchased: "purchased",
          };
          return sourceMap[rawSource] || rawSource.toLowerCase();
        }

        // 添加 XLSX 库
        const script = document.createElement("script");
        script.src =
          "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";
        document.head.appendChild(script);

        // 页面加载时执行
        window.onload = async function () {
          try {
            await checkAdmin();
            console.log("管理员验证通过");

            // 设置日期选择器的默认值为今天
            const today = new Date().toISOString().split("T")[0];
            document.getElementById("dateFilter").value = today;

            // 并行加载数据以提高性能
            await Promise.all([
              loadUsers().catch((e) => console.error("加载用户列表失败:", e)),
              loadStores().catch((e) => console.error("加载店铺列表失败:", e)),
              loadStoreOptions().catch((e) =>
                console.error("加载店铺选项失败:", e)
              ),
              loadLogs().catch((e) => console.error("加载日志失败:", e)),
              loadTodaySalesStats().catch((e) =>
                console.error("加载今日销售统计失败:", e)
              ),
            ]);

            filterLogs();
          } catch (error) {
            console.error("页面加载失败:", error);
            alert("页面加载失败，请刷新重试");
          }
        };

        // 在 script 标签中添加新函数
        async function createDailyProductSalesClass() {
          try {
            addSalesLog("开始创建 DailyProductSales Class...");

            // 创建一个临时对象并保存，这样会自动创建 class
            const DailyProductSales = AV.Object.extend("DailyProductSales");
            const tempSale = new DailyProductSales();
            tempSale.set("temp", true);
            await tempSale.save();
            await tempSale.destroy();

            addSalesLog("DailyProductSales Class 创建成功", "success");
            return true;
          } catch (error) {
            addSalesLog(
              `创建 DailyProductSales Class 失败: ${error.message}`,
              "error"
            );
            return false;
          }
        }

        // 商品列表状态管理
        const productState = {
          allProducts: [],
          filteredProducts: [],
          currentPage: 1,
          pageSize: 10,
          sortField: "name",
          sortDirection: "asc",
          filters: {
            category: "all",
            source: "all",
            search: "",
          },
        };

        // 获取商品列表
        async function fetchProducts() {
          try {
            const query = new AV.Query("Product");
            query.limit(1000);
            const products = await query.find();

            // 设置烘焙类商品的默认来源
            products.forEach((product) => {
              if (
                product.get("category") === "烘焙类" &&
                !product.get("source")
              ) {
                product.set("source", "诚意");
                product.save().catch((error) => {
                  console.error("设置默认来源失败:", error);
                });
              }
            });

            return products;
          } catch (error) {
            console.error("获取商品列表失败:", error);
            return [];
          }
        }

        // 过滤商品
        let allProducts = [];
        let filteredProducts = [];

        async function loadProducts() {
          allProducts = await fetchProducts();
          filterProducts();
        }

        function filterProducts() {
          const category = document.getElementById("categoryFilter").value;
          const searchText = document
            .getElementById("searchInput")
            .value.toLowerCase();

          filteredProducts = allProducts.filter((product) => {
            const matchCategory =
              category === "all" || product.get("category") === category;
            const matchName = product
              .get("name")
              .toLowerCase()
              .includes(searchText);
            return matchCategory && matchName;
          });

          renderProducts();
        }

        // 渲染商品列表
        function renderProducts() {
          const tbody = document.getElementById("productList");
          tbody.innerHTML = filteredProducts
            .map(
              (product) => `
            <tr>
              <td>
                <input type="checkbox" class="product-checkbox" data-id="${
                  product.id
                }">
              </td>
              <td>${product.get("name")}</td>
              <td>${product.get("category") || "-"}</td>
              <td>${getSourceText(product.get("source"))}</td>
              <td>
                <select class="source-select" data-id="${product.id}">
                  <option value="自制" ${
                    product.get("category") === "烘焙类" ? "" : "selected"
                  }>自制</option>
                  <option value="诚意" ${
                    product.get("category") === "烘焙类" ? "selected" : ""
                  }>诚意</option>
                  <option value="老广">老广</option>
                  <option value="其他">其他</option>
                </select>
              </td>
            </tr>
          `
            )
            .join("");
        }

        // 全选/取消全选
        function toggleSelectAll() {
          const selectAll = document.getElementById("selectAll");
          const checkboxes =
            document.getElementsByClassName("product-checkbox");
          Array.from(checkboxes).forEach((checkbox) => {
            checkbox.checked = selectAll.checked;
          });
        }

        // 获取来源文本
        function getSourceText(source) {
          if (!source) {
            return "其他"; // 对于空值返回"其他"
          }
          switch (source) {
            case "自制":
            case "self_made": // 处理历史数据
              return "自制";
            case "诚意":
            case "chengyi": // 处理历史数据
            case "purchased_chengyi": // 处理历史数据
              return "诚意";
            case "老广":
            case "laoguang": // 处理历史数据
            case "purchased_laoguang": // 处理历史数据
              return "老广";
            case "其他":
            case "other": // 处理历史数据
            case "purchased": // 处理历史数据
            default:
              return "其他";
          }
        }

        // 更新选中商品的来源
        async function updateSelectedSources() {
          try {
            const checkboxes =
              document.getElementsByClassName("product-checkbox");
            const selectedProducts = Array.from(checkboxes)
              .filter((checkbox) => checkbox.checked)
              .map((checkbox) => {
                const productId = checkbox.dataset.id;
                const newSource = document.querySelector(
                  `.source-select[data-id="${productId}"]`
                ).value;
                return { productId, newSource };
              });

            if (selectedProducts.length === 0) {
              alert("请选择要更新的商品");
              return;
            }

            if (
              !confirm(`确定要更新 ${selectedProducts.length} 个商品的来源吗？`)
            ) {
              return;
            }

            // 显示进度信息
            const statusDiv = document.createElement("div");
            statusDiv.style.position = "fixed";
            statusDiv.style.top = "50%";
            statusDiv.style.left = "50%";
            statusDiv.style.transform = "translate(-50%, -50%)";
            statusDiv.style.padding = "20px";
            statusDiv.style.background = "white";
            statusDiv.style.border = "1px solid #ccc";
            statusDiv.style.borderRadius = "5px";
            statusDiv.style.boxShadow = "0 2px 4px rgba(0,0,0,0.2)";
            statusDiv.style.zIndex = "1000";
            document.body.appendChild(statusDiv);

            // 分批处理，每批5个商品
            const batchSize = 5;
            const delay = 1000; // 每批之间延迟1秒
            let successCount = 0;
            let failCount = 0;

            for (let i = 0; i < selectedProducts.length; i += batchSize) {
              const batch = selectedProducts.slice(i, i + batchSize);
              statusDiv.textContent = `正在更新第 ${i + 1} 到 ${Math.min(
                i + batchSize,
                selectedProducts.length
              )} 个商品...`;

              try {
                const updates = batch.map(({ productId, newSource }) => {
                  const product = AV.Object.createWithoutData(
                    "Product",
                    productId
                  );
                  product.set("source", newSource);
                  return product.save();
                });

                await Promise.all(updates);
                successCount += batch.length;
              } catch (error) {
                console.error(`批次更新失败:`, error);
                failCount += batch.length;
              }

              // 最后一批不需要延迟
              if (i + batchSize < selectedProducts.length) {
                await new Promise((resolve) => setTimeout(resolve, delay));
              }
            }

            // 移除状态显示
            document.body.removeChild(statusDiv);

            // 显示最终结果
            if (failCount === 0) {
              alert(`更新成功！共更新 ${successCount} 个商品。`);
            } else {
              alert(
                `更新完成。\n成功：${successCount} 个\n失败：${failCount} 个`
              );
            }

            // 重新加载商品列表
            await loadProducts();
          } catch (error) {
            console.error("更新商品来源失败:", error);
            alert("更新失败: " + error.message);
          }
        }

        // 页面加载时执行
        loadProducts();

        // 批量更新烘焙类商品的来源
        async function updateBakeryProducts() {
          try {
            const query = new AV.Query("Product");
            query.equalTo("category", "烘焙类");
            query.limit(1000);
            const products = await query.find();

            const updates = products.map((product) => {
              product.set("source", "诚意");
              return product.save();
            });

            await Promise.all(updates);
            alert(
              `更新完成！共更新 ${products.length} 个烘焙类商品的来源为"诚意"`
            );

            // 重新加载商品列表
            await loadProducts();
          } catch (error) {
            console.error("批量更新失败:", error);
            alert("更新失败: " + error.message);
          }
        }

        // 批量更新销售数据中的店铺名称
        async function updateStoreNames() {
          const statusDiv = document.getElementById("updateStatus");
          try {
            statusDiv.innerHTML = "正在获取销售数据...";

            // 获取所有销售数据
            const query = new AV.Query("DailyProductSales");
            query.limit(1000);
            const sales = await query.find();

            statusDiv.innerHTML += "<br>开始处理数据...";

            // 分批处理，每批10条记录
            const batchSize = 10;
            const delay = 1000; // 每批之间延迟1秒
            let successCount = 0;
            let failCount = 0;

            for (let i = 0; i < sales.length; i += batchSize) {
              const batch = sales.slice(i, i + batchSize);
              statusDiv.innerHTML += `<br>正在处理第 ${i + 1} 到 ${Math.min(
                i + batchSize,
                sales.length
              )} 条记录...`;

              try {
                const updates = batch
                  .map((sale) => {
                    const oldName = sale.get("storeName");
                    if (oldName && oldName.startsWith("食圈儿 ")) {
                      const newName = oldName.replace("食圈儿 ", "");
                      sale.set("storeName", newName);
                      return sale.save();
                    }
                    return null;
                  })
                  .filter(Boolean);

                await Promise.all(updates);
                successCount += updates.length;
              } catch (error) {
                console.error(`批次更新失败:`, error);
                failCount += batch.length;
              }

              // 最后一批不需要延迟
              if (i + batchSize < sales.length) {
                await new Promise((resolve) => setTimeout(resolve, delay));
              }
            }

            // 显示最终结果
            if (failCount === 0) {
              statusDiv.innerHTML += `<br><br>更新完成！成功更新 ${successCount} 条记录。`;
            } else {
              statusDiv.innerHTML += `<br><br>更新完成。<br>成功：${successCount} 条<br>失败：${failCount} 条`;
            }
          } catch (error) {
            console.error("更新店铺名称失败:", error);
            statusDiv.innerHTML += `<br><br>更新失败: ${error.message}`;
          }
        }
      </script>
    </div>
  </body>
</html>
