<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>修复店铺名称 - 食圈儿后台管理系统</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        min-height: 100vh;
        padding: 20px;
      }

      .header {
        background-color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 20px;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
      }

      .btn-back {
        background-color: #6c757d;
        color: white;
      }

      .btn-primary {
        background-color: #007bff;
        color: white;
      }

      .progress-container {
        margin: 20px 0;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
      }

      .progress {
        width: 0%;
        height: 100%;
        background-color: #007bff;
        transition: width 0.3s ease;
      }

      .log-container {
        margin-top: 20px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 4px;
        max-height: 400px;
        overflow-y: auto;
      }

      .log-entry {
        margin: 5px 0;
        padding: 5px;
        border-bottom: 1px solid #eee;
      }

      .success {
        color: #28a745;
      }

      .error {
        color: #dc3545;
      }

      .warning {
        color: #ffc107;
      }

      .input-group {
        margin: 20px 0;
      }

      .form-control {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .card {
        margin-bottom: 20px;
      }

      .card h2 {
        margin-bottom: 15px;
        color: #333;
      }

      .filter-group {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .filter-input {
        padding: 6px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .pagination {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .btn-sm {
        padding: 4px 8px;
        font-size: 12px;
      }
      th {
        cursor: pointer;
        user-select: none;
      }
      th:hover {
        background-color: #f0f0f0;
      }

      .import-logs {
        max-height: 400px;
        overflow-y: auto;
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        font-family: monospace;
        white-space: pre-wrap;
      }
      .log-entry {
        margin: 2px 0;
        padding: 2px 0;
        border-bottom: 1px solid #eee;
      }
      .log-stats {
        color: #0066cc;
        font-weight: bold;
      }
      .log-warning {
        color: #cc6600;
      }
      .log-error {
        color: #cc0000;
      }

      .card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .card h4 {
        margin-bottom: 15px;
        color: #333;
        font-size: 18px;
      }

      .button-group {
        margin: 15px 0;
        display: flex;
        gap: 10px;
      }

      .import-logs {
        margin-top: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
        max-height: 400px;
        overflow-y: auto;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .btn-primary {
        background-color: #007bff;
        color: white;
      }

      .btn-success {
        background-color: #28a745;
        color: white;
      }

      .form-control {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px;
      }

      .log-item {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
        background: #f8f9fa;
        border-left: 4px solid #ddd;
      }

      .log-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-size: 12px;
        color: #666;
      }

      .log-content {
        font-size: 14px;
        color: #333;
      }

      .log-type {
        font-weight: bold;
      }

      .log-fix {
        border-left-color: #007bff;
      }

      .log-extract {
        border-left-color: #28a745;
      }

      .log-inventory {
        border-left-color: #fd7e14;
      }

      .log-time {
        color: #888;
      }

      .log-operator {
        color: #666;
        font-weight: bold;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
  </head>
  <body>
    <header class="header">
      <div>
        <a href="admin-panel.html" class="btn btn-back">返回管理面板</a>
      </div>
      <div class="user-info">
        <span id="adminName">管理员</span>
      </div>
    </header>

    <div class="container">
      <div class="card">
        <h2>修复历史盘点记录的店铺名称</h2>

        <div class="progress-container">
          <div class="progress-bar">
            <div id="progressBar" class="progress"></div>
          </div>
          <div id="progressText" style="text-align: center; margin-top: 10px">
            准备开始...
          </div>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 20px">
          <button
            id="createStoreClassBtn"
            class="btn btn-primary"
            onclick="createStoreClass()"
          >
            创建Store Class
          </button>
          <button id="startButton" class="btn btn-primary" onclick="startFix()">
            开始修复
          </button>
          <button
            id="importSalesButton"
            class="btn btn-primary"
            onclick="importHistoricalSales()"
          >
            导入历史销售数据
          </button>
        </div>

        <div class="log-container" id="logContainer">
          <!-- 日志将在这里显示 -->
        </div>
      </div>

      <div class="card">
        <h2>导入历史销售数据</h2>

        <div style="display: flex; gap: 10px; margin-bottom: 20px">
          <button
            id="createDailyProductSalesClassBtn"
            class="btn btn-primary"
            onclick="createDailyProductSalesClass()"
          >
            创建 DailyProductSales Class
          </button>
        </div>

        <div class="input-group" style="margin: 20px 0">
          <label
            for="salesFolderPath"
            style="display: block; margin-bottom: 10px"
            >数据文件夹路径：</label
          >
          <div style="display: flex; gap: 10px">
            <input
              type="text"
              id="salesFolderPath"
              class="form-control"
              style="
                flex: 1;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
              "
              placeholder="例如：F:/Dropbox/LifeCoreValue/ChengduSubway/Model/foooodis/data/sales/"
            />
            <button class="btn btn-primary" onclick="scanSalesFolder()">
              扫描文件夹
            </button>
          </div>
        </div>

        <div class="input-group" style="margin: 20px 0">
          <label for="salesDataPath" style="display: block; margin-bottom: 10px"
            >单个文件导入：</label
          >
          <div style="display: flex; gap: 10px">
            <input
              type="text"
              id="salesDataPath"
              class="form-control"
              style="
                flex: 1;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
              "
              placeholder="例如：F:/Dropbox/LifeCoreValue/ChengduSubway/Model/foooodis/data/sales_2024_03.xlsx"
            />
            <button class="btn btn-primary" onclick="loadSalesFile()">
              加载文件
            </button>
          </div>
        </div>

        <div class="progress-container">
          <div class="progress-bar">
            <div id="salesProgressBar" class="progress"></div>
          </div>
          <div
            id="salesProgressText"
            style="text-align: center; margin-top: 10px"
          >
            等待操作...
          </div>
        </div>

        <div class="log-container" id="salesLogContainer">
          <!-- 销售数据导入日志将在这里显示 -->
        </div>
      </div>

      <!-- 商品管理卡片 -->
      <div class="card">
        <h2>商品管理</h2>
        <div style="margin-bottom: 20px">
          <button
            id="createProductClassBtn"
            class="btn btn-primary"
            onclick="createProductClass()"
          >
            创建 Product Class
          </button>
          <button class="btn btn-primary" onclick="extractAndUpdateProducts()">
            从销售数据提取商品
          </button>
        </div>

        <!-- 商品列表表格 -->
        <div class="table-container">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
            "
          >
            <div class="filter-group">
              <select
                id="categoryFilter"
                class="filter-input"
                onchange="filterProducts()"
              >
                <option value="all">所有类别</option>
                <option value="main_dish">主食类</option>
                <option value="snack">小吃类</option>
                <option value="drink">饮品类</option>
                <option value="bakery">烘焙类</option>
              </select>
              <select
                id="sourceFilter"
                class="filter-input"
                onchange="filterProducts()"
              >
                <option value="all">所有来源</option>
                <option value="self_made">自制</option>
                <option value="purchased">外采</option>
              </select>
              <input
                type="text"
                id="searchInput"
                class="filter-input"
                placeholder="搜索商品名称..."
                oninput="filterProducts()"
              />
            </div>
            <div class="pagination">
              <span>每页显示：</span>
              <select
                id="pageSize"
                class="filter-input"
                onchange="updatePageSize()"
              >
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th onclick="sortProducts('name')">
                  商品名称 <span id="sortName"></span>
                </th>
                <th onclick="sortProducts('category')">
                  类型 <span id="sortCategory"></span>
                </th>
                <th onclick="sortProducts('source')">
                  来源 <span id="sortSource"></span>
                </th>
                <th onclick="sortProducts('price')">
                  单价 <span id="sortPrice"></span>
                </th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="productsTable">
              <!-- 商品列表将通过 JavaScript 动态生成 -->
            </tbody>
          </table>

          <div class="pagination" style="margin-top: 10px">
            <button class="btn btn-sm" onclick="previousPage()">
              &lt; 上一页
            </button>
            <span id="pageInfo">第 1 页，共 1 页</span>
            <button class="btn btn-sm" onclick="nextPage()">下一页 &gt;</button>
          </div>
        </div>

        <div class="log-container" id="productLogContainer">
          <!-- 商品管理日志将在这里显示 -->
        </div>
      </div>

      <!-- 导入盘点数据卡片 -->
      <div class="card">
        <h2>导入盘点数据</h2>
        <div class="form-group">
          <label>选择盘点数据文件</label>
          <input
            type="file"
            id="inventoryFile"
            accept=".json"
            class="form-control"
            style="margin-bottom: 10px"
          />
        </div>
        <div class="button-group">
          <button class="btn btn-primary" onclick="importInventoryData()">
            导入数据
          </button>
          <button class="btn btn-success" onclick="updateSalesData()">
            更新销售数据
          </button>
        </div>
        <div
          id="importStatus"
          class="log-container"
          style="margin-top: 10px"
        ></div>
      </div>

      <script>
        // 初始化 LeanCloud
        AV.init({
          appId: "mkIfcbivpuTduCrNfh53VqYV-MdYXbMMI",
          appKey: "e4T5MriHgEYtmK7YPvV64awF",
          serverURL: "https://mkifcbivputducrnfh53vqyv.api.lncldglobal.com",
        });

        // 检查管理员权限
        async function checkAdmin() {
          const currentUser = AV.User.current();
          if (!currentUser) {
            window.location.href = "index.html";
            return;
          }

          const userData = JSON.parse(localStorage.getItem("user"));
          if (userData.role !== "admin") {
            alert("您没有访问此页面的权限");
            window.location.href = "select-store.html";
            return;
          }

          document.getElementById("adminName").textContent = userData.name;
        }

        // 添加日志
        function addLog(message, type = "") {
          const logContainer = document.getElementById("logContainer");
          const logEntry = document.createElement("div");
          logEntry.className = `log-entry ${type}`;
          logEntry.textContent = message;
          logContainer.insertBefore(logEntry, logContainer.firstChild);
        }

        // 更新进度
        function updateProgress(current, total) {
          const percentage = (current / total) * 100;
          document.getElementById("progressBar").style.width = percentage + "%";
          document.getElementById(
            "progressText"
          ).textContent = `处理进度: ${current}/${total} (${percentage.toFixed(
            1
          )}%)`;
        }

        // 开始修复
        async function startFix() {
          try {
            // 禁用开始按钮
            document.getElementById("startButton").disabled = true;
            addLog("开始修复流程...");

            // 获取所有店铺信息
            const stores =
              window.stores || JSON.parse(localStorage.getItem("stores"));
            if (!stores) {
              throw new Error("无法获取店铺信息");
            }

            // 创建店铺ID到名称的映射
            const storeMap = {};
            Object.entries(stores).forEach(([type, storeList]) => {
              storeList.forEach((store) => {
                storeMap[store.id] = `${store.brand} ${store.name}`;
              });
            });

            // 查询所有没有店铺名称的盘点记录
            const query = new AV.Query("InventoryCheck");
            query.doesNotExist("storeName");
            query.limit(1000); // 最大限制
            const records = await query.find();

            addLog(`找到 ${records.length} 条需要修复的记录`);

            let successCount = 0;
            let errorCount = 0;

            // 更新每条记录
            for (let i = 0; i < records.length; i++) {
              const record = records[i];
              try {
                const storeId = record.get("storeId");
                if (storeId && storeMap[storeId]) {
                  record.set("storeName", storeMap[storeId]);
                  await record.save();
                  addLog(
                    `成功更新记录 ${record.id}，店铺名称: ${storeMap[storeId]}`,
                    "success"
                  );
                  successCount++;
                } else {
                  addLog(`记录 ${record.id} 缺少有效的店铺ID`, "warning");
                  errorCount++;
                }
              } catch (error) {
                addLog(`更新记录 ${record.id} 失败: ${error.message}`, "error");
                errorCount++;
              }

              updateProgress(i + 1, records.length);
            }

            // 显示最终结果
            addLog(
              `修复完成！成功: ${successCount}, 失败: ${errorCount}`,
              successCount > 0 ? "success" : "error"
            );
          } catch (error) {
            addLog(`发生错误: ${error.message}`, "error");
          } finally {
            // 重新启用开始按钮
            document.getElementById("startButton").disabled = false;
          }
        }

        // 创建 Store Class
        async function createStoreClass() {
          try {
            document.getElementById("createStoreClassBtn").disabled = true;
            addLog("开始创建 Store Class...");

            // 获取所有店铺信息
            const stores =
              window.stores || JSON.parse(localStorage.getItem("stores"));
            if (!stores) {
              throw new Error("无法获取店铺信息");
            }

            // 创建 Store class
            const Store = AV.Object.extend("Store");

            // 先创建一个临时对象并保存，这样会自动创建 class
            const tempStore = new Store();
            tempStore.set("temp", true);
            await tempStore.save();
            await tempStore.destroy();
            addLog("Store Class 创建成功");

            // 查询现有数据
            const query = new AV.Query("Store");
            const existingStores = await query.find();

            // 删除现有的店铺数据
            if (existingStores.length > 0) {
              addLog(`删除 ${existingStores.length} 条现有店铺数据...`);
              for (const store of existingStores) {
                await store.destroy();
              }
            }

            // 同步直营店数据
            addLog(`开始同步 ${stores.direct.length} 家直营店数据...`);
            for (const store of stores.direct) {
              const storeObj = new Store();
              storeObj.set("storeId", store.id);
              storeObj.set("brand", "食圈儿");
              storeObj.set("name", store.name);
              storeObj.set("type", "direct");
              storeObj.set("address", store.address);
              storeObj.set("status", store.status || "open");
              await storeObj.save();
              addLog(`已同步直营店: ${store.name}`, "success");
            }

            // 同步加盟店数据
            addLog(`开始同步 ${stores.franchise.length} 家加盟店数据...`);
            for (const store of stores.franchise) {
              const storeObj = new Store();
              storeObj.set("storeId", store.id);
              storeObj.set("brand", "食圈儿");
              storeObj.set("name", store.name);
              storeObj.set("type", "franchise");
              storeObj.set("address", store.address);
              storeObj.set("status", store.status || "open");
              await storeObj.save();
              addLog(`已同步加盟店: ${store.name}`, "success");
            }

            addLog("Store Class 创建和数据同步完成！", "success");
          } catch (error) {
            console.error("创建 Store Class 失败:", error);
            addLog(`创建失败: ${error.message}`, "error");
          } finally {
            document.getElementById("createStoreClassBtn").disabled = false;
          }
        }

        // 导入历史销售数据
        async function importHistoricalSales() {
          try {
            document.getElementById("importSalesButton").disabled = true;
            addLog("开始导入历史销售数据...");

            // 读取历史数据文件夹中的文件
            const response = await fetch("db/historical_sales/");
            if (!response.ok) {
              throw new Error("无法访问历史数据文件夹");
            }

            const files = await response.json();
            addLog(`找到 ${files.length} 个数据文件`);

            // 创建 DailyProductSales class
            const DailyProductSales = AV.Object.extend("DailyProductSales");

            // 遍历每个文件
            for (const file of files) {
              try {
                const fileResponse = await fetch(`db/historical_sales/${file}`);
                const salesData = await fileResponse.json();

                addLog(`处理文件: ${file}`);

                // 解析文件名中的日期和店铺信息
                const [date, storeName] = file.replace(".json", "").split("_");
                const salesDate = new Date(date);

                // 检查是否已存在该日期和店铺的数据
                const query = new AV.Query("DailyProductSales");
                query.equalTo("date", salesDate);
                query.equalTo("storeName", `食圈儿 ${storeName}`);
                const existingData = await query.find();

                // 如果已存在数据，则跳过
                if (existingData.length > 0) {
                  addLog(`${date} ${storeName} 的数据已存在，跳过`, "warning");
                  continue;
                }

                // 导入数据
                for (const item of salesData) {
                  const sale = new DailyProductSales();
                  sale.set("date", salesDate);
                  sale.set("storeName", `食圈儿 ${storeName}`);
                  sale.set("productName", item.productName);
                  sale.set("category", item.category);
                  sale.set("source", item.source);
                  sale.set("quantity", item.quantity);
                  sale.set("price", item.price);
                  await sale.save();
                }

                addLog(
                  `成功导入 ${salesData.length} 条数据: ${date} ${storeName}`,
                  "success"
                );
              } catch (error) {
                addLog(`处理文件 ${file} 失败: ${error.message}`, "error");
              }
            }

            addLog("历史销售数据导入完成！", "success");
          } catch (error) {
            console.error("导入历史销售数据失败:", error);
            addLog(`导入失败: ${error.message}`, "error");
          } finally {
            document.getElementById("importSalesButton").disabled = false;
          }
        }

        // 添加销售日志
        function addSalesLog(message, type = "") {
          const logContainer = document.getElementById("salesLogContainer");
          const logEntry = document.createElement("div");
          logEntry.className = `log-entry ${type}`;
          logEntry.textContent = message;
          logContainer.insertBefore(logEntry, logContainer.firstChild);
        }

        // 更新销售导入进度
        function updateSalesProgress(current, total) {
          const percentage = (current / total) * 100;
          document.getElementById("salesProgressBar").style.width =
            percentage + "%";
          document.getElementById(
            "salesProgressText"
          ).textContent = `处理进度: ${current}/${total} (${percentage.toFixed(
            1
          )}%)`;
        }

        // 加载并处理销售数据文件
        async function loadSalesFile() {
          try {
            const fileInput = document.createElement("input");
            fileInput.type = "file";
            fileInput.accept = ".xlsx,.xls";
            fileInput.onchange = async function (e) {
              try {
                const file = e.target.files[0];
                addSalesLog(`开始处理文件: ${file.name}`);

                // 使用 XLSX 读取文件
                const data = await readExcelFile(file);
                if (data && data.length > 0) {
                  await importSalesData(data);
                  addSalesLog(`文件处理完成: ${file.name}`, "success");
                } else {
                  addSalesLog(
                    `文件中没有找到有效数据: ${file.name}`,
                    "warning"
                  );
                }
              } catch (error) {
                addSalesLog(`处理文件失败: ${error.message}`, "error");
              }
            };

            fileInput.click();
          } catch (error) {
            addSalesLog(`加载文件失败: ${error.message}`, "error");
          }
        }

        // 导入销售数据
        async function importSalesData(salesData) {
          try {
            addSalesLog("开始导入数据到 LeanCloud...");

            // 确保 DailyProductSales class 存在
            const DailyProductSales = AV.Object.extend("DailyProductSales");

            // 尝试查询，如果失败则创建 class
            try {
              const query = new AV.Query("DailyProductSales");
              await query.first();
            } catch (error) {
              if (error.code === 404) {
                const created = await createDailyProductSalesClass();
                if (!created) {
                  throw new Error("无法创建 DailyProductSales Class");
                }
              }
            }

            let successCount = 0;
            let errorCount = 0;
            const batchSize = 100; // 每批处理100条记录
            const batches = [];

            // 将数据分批
            for (let i = 0; i < salesData.length; i += batchSize) {
              batches.push(salesData.slice(i, i + batchSize));
            }

            addSalesLog(
              `将分 ${batches.length} 批处理数据，每批 ${batchSize} 条`
            );

            // 处理每一批数据
            for (
              let batchIndex = 0;
              batchIndex < batches.length;
              batchIndex++
            ) {
              const batch = batches[batchIndex];
              const batchObjects = [];
              const existingRecords = new Set();

              // 先批量查询已存在的记录
              const queries = batch.map((item) => {
                const query = new AV.Query("DailyProductSales");
                query.equalTo("date", new Date(item.date));
                query.equalTo("storeName", item.storeName);
                query.equalTo("productName", item.productName);
                return query;
              });

              const compositeQuery = AV.Query.or(...queries);
              const existing = await compositeQuery.find();

              // 记录已存在的记录标识
              existing.forEach((record) => {
                const key = `${record.get("date").toISOString()}_${record.get(
                  "storeName"
                )}_${record.get("productName")}`;
                existingRecords.add(key);
              });

              // 创建新记录
              for (const item of batch) {
                const key = `${new Date(item.date).toISOString()}_${
                  item.storeName
                }_${item.productName}`;
                if (!existingRecords.has(key)) {
                  const sale = new DailyProductSales();
                  sale.set("date", new Date(item.date));
                  sale.set("storeName", item.storeName);
                  sale.set("productName", item.productName);
                  sale.set("category", item.category);
                  sale.set("source", item.source);
                  sale.set("quantity", item.quantity);
                  sale.set("price", item.price);
                  batchObjects.push(sale);
                } else {
                  addSalesLog(
                    `跳过重复记录: ${item.date} ${item.storeName} ${item.productName}`,
                    "warning"
                  );
                }
              }

              if (batchObjects.length > 0) {
                try {
                  await AV.Object.saveAll(batchObjects);
                  successCount += batchObjects.length;
                  addSalesLog(
                    `成功导入第 ${batchIndex + 1}/${
                      batches.length
                    } 批数据，本批导入 ${batchObjects.length} 条记录`,
                    "success"
                  );
                } catch (error) {
                  errorCount += batchObjects.length;
                  addSalesLog(`批量导入失败: ${error.message}`, "error");
                }
              }

              // 更新进度
              updateSalesProgress(
                Math.min((batchIndex + 1) * batchSize, salesData.length),
                salesData.length
              );
            }

            addSalesLog(
              `导入完成！成功: ${successCount}, 失败: ${errorCount}`,
              successCount > 0 ? "success" : "error"
            );
          } catch (error) {
            addSalesLog(`导入过程发生错误: ${error.message}`, "error");
          }
        }

        // 扫描销售数据文件夹
        async function scanSalesFolder() {
          try {
            // 创建文件夹选择器
            const folderInput = document.createElement("input");
            folderInput.type = "file";
            folderInput.webkitdirectory = true;
            folderInput.multiple = true;

            folderInput.onchange = async function (e) {
              try {
                const files = Array.from(e.target.files).filter(
                  (file) =>
                    file.name.endsWith(".xlsx") || file.name.endsWith(".xls")
                );

                if (files.length === 0) {
                  addSalesLog("未找到Excel文件", "warning");
                  return;
                }

                addSalesLog(`找到 ${files.length} 个Excel文件，开始处理...`);

                // 按文件名排序（假设文件名包含日期）
                files.sort((a, b) => a.name.localeCompare(b.name));

                let successCount = 0;
                let errorCount = 0;

                for (let i = 0; i < files.length; i++) {
                  try {
                    const file = files[i];
                    addSalesLog(
                      `处理文件 ${i + 1}/${files.length}: ${file.name}`
                    );

                    // 使用 XLSX 库读取 Excel 文件
                    const data = await readExcelFile(file);
                    if (data && data.length > 0) {
                      await importSalesData(data);
                      successCount++;
                    }

                    // 更新总进度
                    updateSalesProgress(i + 1, files.length);
                  } catch (error) {
                    errorCount++;
                    addSalesLog(
                      `处理文件 ${files[i].name} 失败: ${error.message}`,
                      "error"
                    );
                  }
                }

                addSalesLog(
                  `所有文件处理完成！成功: ${successCount}, 失败: ${errorCount}`,
                  successCount > 0 ? "success" : "error"
                );
              } catch (error) {
                addSalesLog(`扫描文件夹失败: ${error.message}`, "error");
              }
            };

            folderInput.click();
          } catch (error) {
            addSalesLog(`选择文件夹失败: ${error.message}`, "error");
          }
        }

        // 读取Excel文件
        async function readExcelFile(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = async function (e) {
              try {
                const data = e.target.result;
                const workbook = XLSX.read(data, { type: "array" });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                // 将 Excel 数据转换为对象数组
                const rawData = XLSX.utils.sheet_to_json(worksheet);

                // 处理数据，使用英文列名
                const processedData = rawData.map((row) => ({
                  date: row["Date"] || "",
                  storeName: `食圈儿 ${row["Store"] || ""}`,
                  productName: row["Product"] || "",
                  category: mapCategory(row["Category"] || ""),
                  source: mapSource(row["Source"] || ""),
                  quantity: parseInt(row["Sale"] || 0),
                  price: parseFloat(row["Price"] || 0),
                }));

                resolve(processedData);
              } catch (error) {
                reject(error);
              }
            };
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
          });
        }

        // 映射类型
        function mapCategory(rawCategory) {
          const categoryMap = {
            主食: "main_dish",
            小吃: "snack",
            饮品: "drink",
            "Main Dish": "main_dish",
            Snack: "snack",
            Drink: "drink",
          };
          return categoryMap[rawCategory] || rawCategory.toLowerCase();
        }

        // 映射来源
        function mapSource(rawSource) {
          const sourceMap = {
            自制: "self_made",
            外采: "purchased",
            "Self Made": "self_made",
            Purchased: "purchased",
          };
          return sourceMap[rawSource] || rawSource.toLowerCase();
        }

        // 添加 XLSX 库
        const script = document.createElement("script");
        script.src =
          "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";
        document.head.appendChild(script);

        // 页面加载时执行
        window.onload = async function () {
          try {
            await checkAdmin();
            console.log("管理员验证通过");

            // 设置日期选择器的默认值为今天
            const today = new Date().toISOString().split("T")[0];
            document.getElementById("dateFilter").value = today;

            // 并行加载数据以提高性能
            await Promise.all([
              loadUsers().catch((e) => console.error("加载用户列表失败:", e)),
              loadStores().catch((e) => console.error("加载店铺列表失败:", e)),
              loadStoreOptions().catch((e) =>
                console.error("加载店铺选项失败:", e)
              ),
              loadLogs().catch((e) => console.error("加载日志失败:", e)),
              loadTodaySalesStats().catch((e) =>
                console.error("加载今日销售统计失败:", e)
              ),
            ]);

            filterLogs();
          } catch (error) {
            console.error("页面加载失败:", error);
            alert("页面加载失败，请刷新重试");
          }
        };

        // 在 script 标签中添加新函数
        async function createDailyProductSalesClass() {
          try {
            addSalesLog("开始创建 DailyProductSales Class...");

            // 创建一个临时对象并保存，这样会自动创建 class
            const DailyProductSales = AV.Object.extend("DailyProductSales");
            const tempSale = new DailyProductSales();
            tempSale.set("temp", true);
            await tempSale.save();
            await tempSale.destroy();

            addSalesLog("DailyProductSales Class 创建成功", "success");
            return true;
          } catch (error) {
            addSalesLog(
              `创建 DailyProductSales Class 失败: ${error.message}`,
              "error"
            );
            return false;
          }
        }

        // 商品列表状态管理
        const productState = {
          allProducts: [],
          filteredProducts: [],
          currentPage: 1,
          pageSize: 10,
          sortField: "name",
          sortDirection: "asc",
          filters: {
            category: "all",
            source: "all",
            search: "",
          },
        };

        // 加载商品列表
        async function loadProducts() {
          try {
            const query = new AV.Query("Product");
            query.limit(1000);
            const products = await query.find();

            productState.allProducts = products.map((p) => ({
              id: p.id,
              name: p.get("name"),
              category: p.get("category"),
              source: p.get("source"),
              price: p.get("price"),
            }));

            filterProducts();
          } catch (error) {
            console.error("加载商品列表失败:", error);
            alert("加载商品列表失败");
          }
        }

        // 过滤商品
        function filterProducts() {
          productState.filters.category =
            document.getElementById("categoryFilter").value;
          productState.filters.source =
            document.getElementById("sourceFilter").value;
          productState.filters.search = document
            .getElementById("searchInput")
            .value.toLowerCase();

          productState.filteredProducts = productState.allProducts.filter(
            (product) => {
              const categoryMatch =
                productState.filters.category === "all" ||
                product.category === productState.filters.category;
              const sourceMatch =
                productState.filters.source === "all" ||
                product.source === productState.filters.source;
              const searchMatch = product.name
                .toLowerCase()
                .includes(productState.filters.search);
              return categoryMatch && sourceMatch && searchMatch;
            }
          );

          sortProducts(productState.sortField, true);
          productState.currentPage = 1;
          renderProducts();
        }

        // 排序商品
        function sortProducts(field, keepDirection = false) {
          if (!keepDirection) {
            productState.sortDirection =
              productState.sortField === field
                ? productState.sortDirection === "asc"
                  ? "desc"
                  : "asc"
                : "asc";
          }
          productState.sortField = field;

          // 更新排序图标
          const fields = ["name", "category", "source", "price"];
          fields.forEach((f) => {
            const span = document.getElementById(
              `sort${f.charAt(0).toUpperCase() + f.slice(1)}`
            );
            span.textContent =
              f === field
                ? productState.sortDirection === "asc"
                  ? " ↑"
                  : " ↓"
                : "";
          });

          productState.filteredProducts.sort((a, b) => {
            let comparison = 0;
            if (field === "price") {
              comparison = a[field] - b[field];
            } else {
              comparison = String(a[field]).localeCompare(String(b[field]));
            }
            return productState.sortDirection === "asc"
              ? comparison
              : -comparison;
          });

          renderProducts();
        }

        // 更新每页显示数量
        function updatePageSize() {
          productState.pageSize = parseInt(
            document.getElementById("pageSize").value
          );
          productState.currentPage = 1;
          renderProducts();
        }

        // 上一页
        function previousPage() {
          if (productState.currentPage > 1) {
            productState.currentPage--;
            renderProducts();
          }
        }

        // 下一页
        function nextPage() {
          const totalPages = Math.ceil(
            productState.filteredProducts.length / productState.pageSize
          );
          if (productState.currentPage < totalPages) {
            productState.currentPage++;
            renderProducts();
          }
        }

        // 渲染商品列表
        function renderProducts() {
          const tbody = document.getElementById("productsTable");
          const start = (productState.currentPage - 1) * productState.pageSize;
          const end = start + productState.pageSize;
          const pageProducts = productState.filteredProducts.slice(start, end);

          tbody.innerHTML = pageProducts
            .map(
              (product) => `
            <tr>
              <td>${product.name}</td>
              <td>${getCategoryText(product.category)}</td>
              <td>${getSourceText(product.source)}</td>
              <td>¥${product.price.toFixed(2)}</td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="editProduct('${
                  product.id
                }')">编辑</button>
                <button class="btn btn-sm btn-danger" onclick="deleteProduct('${
                  product.id
                }')">删除</button>
              </td>
            </tr>
          `
            )
            .join("");

          // 更新分页信息
          const totalPages = Math.ceil(
            productState.filteredProducts.length / productState.pageSize
          );
          document.getElementById(
            "pageInfo"
          ).textContent = `第 ${productState.currentPage} 页，共 ${totalPages} 页 (共 ${productState.filteredProducts.length} 条)`;
        }

        // 编辑商品
        async function editProduct(id) {
          // TODO: 实现编辑功能
          alert("编辑功能开发中");
        }

        // 删除商品
        async function deleteProduct(id) {
          if (confirm("确定要删除这个商品吗？")) {
            try {
              const product = AV.Object.createWithoutData("Product", id);
              await product.destroy();
              await loadProducts();
              alert("删除成功");
            } catch (error) {
              console.error("删除商品失败:", error);
              alert("删除商品失败");
            }
          }
        }

        // 页面加载时加载商品列表
        window.addEventListener("load", loadProducts);

        async function createProductClass() {
          try {
            addSalesLog("开始创建 Product Class...");

            // 创建一个临时对象并保存，这样会自动创建 class
            const Product = AV.Object.extend("Product");
            const tempProduct = new Product();
            tempProduct.set("temp", true);
            await tempProduct.save();
            await tempProduct.destroy();

            addSalesLog("Product Class 创建成功", "success");
            return true;
          } catch (error) {
            addSalesLog(`创建 Product Class 失败: ${error.message}`, "error");
            return false;
          }
        }

        async function extractAndUpdateProducts() {
          try {
            addSalesLog("开始从销售数据提取商品信息...");

            // 确保 Product class 存在
            try {
              const query = new AV.Query("Product");
              await query.first();
            } catch (error) {
              if (error.code === 404) {
                const created = await createProductClass();
                if (!created) {
                  throw new Error("无法创建 Product Class");
                }
              }
            }

            // 查询所有销售数据
            const query = new AV.Query("DailyProductSales");
            query.limit(1000); // 最大限制
            query.addAscending("productName"); // 按商品名称排序
            const sales = await query.find();

            addSalesLog(`找到 ${sales.length} 条销售记录`);

            // 使用 Map 去重，提取唯一的商品
            const uniqueProducts = new Map();
            sales.forEach((sale) => {
              const key = sale.get("productName");
              if (!uniqueProducts.has(key)) {
                uniqueProducts.set(key, {
                  name: sale.get("productName"),
                  category: sale.get("category"),
                  source: sale.get("source"),
                  price: sale.get("price"),
                });
              }
            });

            addSalesLog(`提取出 ${uniqueProducts.size} 个唯一商品`);

            // 按类别统计商品数量
            const categoryStats = new Map();
            uniqueProducts.forEach((product) => {
              const category = product.category;
              categoryStats.set(
                category,
                (categoryStats.get(category) || 0) + 1
              );
            });

            addSalesLog("\n各类别商品数量：");
            categoryStats.forEach((count, category) => {
              addSalesLog(`- ${getCategoryText(category)}: ${count}个`);
            });

            // 检查现有商品
            const Product = AV.Object.extend("Product");
            const productQuery = new AV.Query(Product);
            const existingProducts = await productQuery.find();
            const existingProductNames = new Set(
              existingProducts.map((p) => p.get("name"))
            );

            // 批量保存新商品
            const newProducts = [];
            for (const [name, data] of uniqueProducts) {
              if (!existingProductNames.has(name)) {
                const product = new Product();
                product.set("name", data.name);
                product.set("category", data.category);
                product.set("source", data.source);
                product.set("price", data.price);
                newProducts.push(product);
              }
            }

            if (newProducts.length > 0) {
              await AV.Object.saveAll(newProducts);
              addSalesLog(`成功添加 ${newProducts.length} 个新商品`, "success");

              // 显示所有添加的商品
              addSalesLog("\n新添加的商品列表：", "success");
              newProducts.forEach((product) => {
                addSalesLog(
                  `- ${product.get("name")} (${getCategoryText(
                    product.get("category")
                  )}, ${getSourceText(product.get("source"))}, ¥${product.get(
                    "price"
                  )})`,
                  "success"
                );
              });
            } else {
              addSalesLog("没有新商品需要添加", "warning");
            }

            // 显示所有商品列表
            addSalesLog("\n当前所有商品列表：");
            // 按类别分组显示
            const productsByCategory = new Map();
            Array.from(uniqueProducts.values()).forEach((product) => {
              const category = product.category;
              if (!productsByCategory.has(category)) {
                productsByCategory.set(category, []);
              }
              productsByCategory.get(category).push(product);
            });

            // 按类别显示商品
            productsByCategory.forEach((products, category) => {
              addSalesLog(`\n${getCategoryText(category)}：`);
              products.sort((a, b) => a.name.localeCompare(b.name)); // 按名称排序
              products.forEach((product) => {
                addSalesLog(
                  `- ${product.name} (${getSourceText(product.source)}, ¥${
                    product.price
                  })`
                );
              });
            });

            addSalesLog("\n商品数据更新完成！", "success");
          } catch (error) {
            addSalesLog(`更新商品数据失败: ${error.message}`, "error");
          }
        }

        async function extractProductsByCategory(category) {
          try {
            addSalesLog(`开始提取${getCategoryText(category)}商品信息...`);

            // 确保 Product class 存在
            try {
              const query = new AV.Query("Product");
              await query.first();
            } catch (error) {
              if (error.code === 404) {
                const created = await createProductClass();
                if (!created) {
                  throw new Error("无法创建 Product Class");
                }
              }
            }

            // 查询销售数据，使用日期范围
            const query = new AV.Query("DailyProductSales");
            if (category !== "all") {
              query.equalTo("category", category);
            }

            // 设置较大的限制以获取所有数据
            query.limit(1000);
            query.addAscending("productName");

            // 获取所有销售记录
            let allSales = [];
            let skip = 0;
            let hasMore = true;

            while (hasMore) {
              query.skip(skip);
              const sales = await query.find();
              if (sales.length === 0) {
                hasMore = false;
              } else {
                allSales = allSales.concat(sales);
                skip += sales.length;
                addSalesLog(`已加载 ${allSales.length} 条销售记录...`);
              }
            }

            addSalesLog(`总共找到 ${allSales.length} 条销售记录`);

            // 使用 Map 去重，提取唯一的商品
            const uniqueProducts = new Map();
            allSales.forEach((sale) => {
              const key = sale.get("productName");
              if (!uniqueProducts.has(key)) {
                uniqueProducts.set(key, {
                  name: sale.get("productName"),
                  category: sale.get("category"),
                  source: sale.get("source"),
                  price: sale.get("price"),
                });
              }
            });

            addSalesLog(`提取出 ${uniqueProducts.size} 个唯一商品`);

            // 检查现有商品
            const Product = AV.Object.extend("Product");
            const productQuery = new AV.Query(Product);
            if (category !== "all") {
              productQuery.equalTo("category", category);
            }
            const existingProducts = await productQuery.find();
            const existingProductNames = new Set(
              existingProducts.map((p) => p.get("name"))
            );

            // 批量保存新商品
            const newProducts = [];
            for (const [name, data] of uniqueProducts) {
              if (!existingProductNames.has(name)) {
                const product = new Product();
                product.set("name", data.name);
                product.set("category", data.category);
                product.set("source", data.source);
                product.set("price", data.price);
                newProducts.push(product);
              }
            }

            if (newProducts.length > 0) {
              // 分批保存，避免超出限制
              const batchSize = 50;
              for (let i = 0; i < newProducts.length; i += batchSize) {
                const batch = newProducts.slice(i, i + batchSize);
                await AV.Object.saveAll(batch);
                addSalesLog(
                  `成功添加第 ${i + 1} 到 ${i + batch.length} 个新商品`,
                  "success"
                );
              }
              addSalesLog(
                `总共添加了 ${newProducts.length} 个新商品`,
                "success"
              );
            } else {
              addSalesLog("没有新商品需要添加", "warning");
            }

            // 显示当前类别的所有商品
            addSalesLog(`\n当前${getCategoryText(category)}商品列表：`);
            const productList = Array.from(uniqueProducts.values());

            // 按类别和名称排序
            productList.sort((a, b) => {
              if (a.category !== b.category) {
                return a.category.localeCompare(b.category);
              }
              return a.name.localeCompare(b.name);
            });

            // 按类别分组显示
            let currentCategory = "";
            productList.forEach((product) => {
              if (currentCategory !== product.category) {
                currentCategory = product.category;
                addSalesLog(`\n${getCategoryText(currentCategory)}：`);
              }
              addSalesLog(
                `- ${product.name} (${getSourceText(product.source)}, ¥${
                  product.price
                })`
              );
            });

            addSalesLog("\n商品数据更新完成！", "success");
          } catch (error) {
            addSalesLog(`更新商品数据失败: ${error.message}`, "error");
          }
        }

        // 添加盘点日志
        function addInventoryLog(message, type = "info") {
          const logsDiv = document.getElementById("importLogs");
          const logEntry = document.createElement("div");
          logEntry.className = `log-entry log-${type}`;
          logEntry.textContent = message;
          logsDiv.appendChild(logEntry);
          logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // 更新盘点进度
        function updateInventoryProgress(current, total) {
          const progress = (current / total) * 100;
          const progressBar = document.getElementById("importProgress");
          progressBar.style.width = `${progress}%`;
          progressBar.textContent = `${Math.round(progress)}%`;
        }

        let analyzedData = null; // 存储分析后的数据

        async function importInventoryData() {
          try {
            const file = document.getElementById("inventoryFile").files[0];
            if (!file) {
              addInventoryLog("请选择要导入的文件", "error");
              return;
            }

            addInventoryLog("开始读取文件...", "info");
            const workbook = XLSX.read(await file.arrayBuffer());
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const data = XLSX.utils.sheet_to_json(worksheet);

            // 按日期和店铺分组数据
            const groupedData = new Map();
            const stats = {
              totalRecords: 0,
              stores: new Set(),
              types: new Map(),
              storeTypes: new Map(),
            };

            for (const row of data) {
              const dateStr = row["日期"];
              const storeName = row["店铺名"];
              const product = row["产品"];
              const quantity = row["数量"];
              let type = row["盘点类型"];

              if (
                !dateStr ||
                !storeName ||
                !product ||
                quantity === undefined ||
                !type
              ) {
                addInventoryLog(
                  `跳过无效数据行: ${JSON.stringify(row)}`,
                  "warning"
                );
                continue;
              }

              // 标准化操作类型
              type = normalizeInventoryType(type);
              if (!type) {
                addInventoryLog(
                  `未知的盘点类型: ${row["盘点类型"]}`,
                  "warning"
                );
                continue;
              }

              // 将日期字符串转换为 Date 对象
              const [year, month, day] = dateStr.split("-").map(Number);
              const date = new Date(year, month - 1, day);
              date.setHours(0, 0, 0, 0);

              const key = `${dateStr}_${storeName}_${type}`;
              if (!groupedData.has(key)) {
                groupedData.set(key, {
                  date,
                  storeName,
                  type,
                  items: [],
                });

                // 更新统计信息
                stats.totalRecords++;
                stats.stores.add(storeName);
                stats.types.set(type, (stats.types.get(type) || 0) + 1);

                if (!stats.storeTypes.has(storeName)) {
                  stats.storeTypes.set(storeName, new Set());
                }
                stats.storeTypes.get(storeName).add(type);
              }
              groupedData
                .get(key)
                .items.push({ product, quantity: Number(quantity) });
            }

            // 显示统计信息
            addInventoryLog("\n=== 数据分析结果 ===", "stats");
            addInventoryLog(`总盘点记录数: ${stats.totalRecords}`, "stats");
            addInventoryLog(`涉及店铺数: ${stats.stores.size}`, "stats");
            addInventoryLog("\n按盘点类型统计:", "stats");
            stats.types.forEach((count, type) => {
              addInventoryLog(`${getTypeText(type)}: ${count}条`, "stats");
            });

            addInventoryLog("\n各店铺盘点类型:", "stats");
            stats.stores.forEach((store) => {
              const types = Array.from(stats.storeTypes.get(store))
                .map((type) => getTypeText(type))
                .join(", ");
              addInventoryLog(`${store}: ${types}`, "stats");
            });

            // 检查重复记录
            addInventoryLog("\n开始检查重复记录...", "info");
            const duplicates = [];
            for (const [key, record] of groupedData.entries()) {
              const query = new AV.Query("InventoryCheck");

              // 使用日期字符串进行精确匹配
              const dateStr = record.date.toISOString().split("T")[0];
              addInventoryLog(
                `检查记录: ${dateStr} ${record.storeName} ${getTypeText(
                  record.type
                )}`,
                "info"
              );

              // 获取所有记录以便在日志中显示
              query.equalTo("storeName", record.storeName);
              query.equalTo("type", record.type);
              const allRecords = await query.find();

              // 检查每条记录的日期
              const isDuplicate = allRecords.some((existingRecord) => {
                const existingDateStr = existingRecord
                  .get("date")
                  .toISOString()
                  .split("T")[0];
                const isMatch = existingDateStr === dateStr;
                if (isMatch) {
                  addInventoryLog(
                    `找到匹配记录: ${existingDateStr} ${existingRecord.get(
                      "storeName"
                    )} ${getTypeText(existingRecord.get("type"))}`,
                    "warning"
                  );
                }
                return isMatch;
              });

              if (isDuplicate) {
                duplicates.push({
                  date: dateStr,
                  store: record.storeName,
                  type: getTypeText(record.type),
                });
              }
            }

            if (duplicates.length > 0) {
              addInventoryLog("\n发现重复记录:", "warning");
              duplicates.forEach((dup) => {
                addInventoryLog(
                  `${dup.date} ${dup.store} ${dup.type}`,
                  "warning"
                );
              });
            } else {
              addInventoryLog("未发现重复记录", "success");
            }

            // 保存分析结果供上传使用
            analyzedData = {
              groupedData,
              duplicates,
            };

            // 显示上传按钮
            document.getElementById("uploadButton").style.display =
              "inline-block";
          } catch (error) {
            console.error("分析失败:", error);
            addInventoryLog(`分析失败: ${error.message}`, "error");
          }
        }

        async function uploadInventoryData() {
          if (!analyzedData) {
            addInventoryLog("请先分析数据文件", "error");
            return;
          }

          try {
            addInventoryLog("\n=== 开始上传数据 ===", "info");
            const { groupedData, duplicates } = analyzedData;

            // 创建一个Set来存储重复记录的key
            const duplicateKeys = new Set(
              duplicates.map(
                (dup) => `${dup.date}_${dup.store}_${getTypeText(dup.type)}`
              )
            );

            let uploadedCount = 0;
            let skippedCount = 0;

            for (const [key, record] of groupedData.entries()) {
              const recordKey = `${record.date.toISOString().split("T")[0]}_${
                record.storeName
              }_${getTypeText(record.type)}`;

              // 如果是重复记录，跳过
              if (duplicateKeys.has(recordKey)) {
                addInventoryLog(
                  `跳过重复记录: ${record.date.toISOString().split("T")[0]} ${
                    record.storeName
                  } ${getTypeText(record.type)}`,
                  "warning"
                );
                skippedCount++;
                continue;
              }

              // 创建新记录
              const InventoryCheck = AV.Object.extend("InventoryCheck");
              const inventoryCheck = new InventoryCheck();
              inventoryCheck.set("date", record.date);
              inventoryCheck.set("storeName", record.storeName);
              inventoryCheck.set("type", record.type);
              inventoryCheck.set("items", record.items);
              inventoryCheck.set("status", "submitted");
              inventoryCheck.set("operator", AV.User.current());

              await inventoryCheck.save();
              uploadedCount++;

              // 创建系统日志
              const SystemLog = AV.Object.extend("SystemLog");
              const log = new SystemLog();
              log.set("type", `inventory_${record.type}`);
              log.set("operator", AV.User.current());
              log.set(
                "content",
                `${record.storeName} ${
                  record.date.toISOString().split("T")[0]
                } ${getTypeText(record.type)}`
              );
              log.set("date", record.date);
              await log.save();

              addInventoryLog(
                `成功上传: ${record.date.toISOString().split("T")[0]} ${
                  record.storeName
                } ${getTypeText(record.type)}`,
                "success"
              );
            }

            addInventoryLog(
              `\n上传完成: 成功上传 ${uploadedCount} 条记录，跳过 ${skippedCount} 条重复记录`,
              "success"
            );

            // 清除分析数据
            analyzedData = null;
            // 隐藏上传按钮
            document.getElementById("uploadButton").style.display = "none";
          } catch (error) {
            console.error("上传失败:", error);
            addInventoryLog(`上传失败: ${error.message}`, "error");
          }
        }

        // 标准化盘点类型
        function normalizeInventoryType(type) {
          switch (type.trim()) {
            case "开店":
            case "开店盘点":
              return "opening";
            case "闭店":
            case "闭店盘点":
              return "closing";
            case "进货":
            case "进货盘点":
              return "restocking";
            case "报损":
            case "报损盘点":
              return "loss";
            default:
              return null;
          }
        }

        // 辅助函数：获取盘点类型的中文显示
        function getTypeText(type) {
          switch (type) {
            case "opening":
              return "开店盘点";
            case "closing":
              return "闭店盘点";
            case "restocking":
              return "进货盘点";
            case "loss":
              return "报损盘点";
            default:
              return type;
          }
        }

        // 加载系统日志
        async function loadSystemLogs() {
          try {
            const query = new AV.Query("SystemLog");
            query.descending("createdAt");
            query.limit(1000);

            // 添加盘点相关的类型
            query.containedIn("type", [
              "store_name_fix",
              "product_extract",
              "inventory_opening",
              "inventory_closing",
              "inventory_restocking",
              "inventory_loss",
            ]);

            const logs = await query.find();
            const logsDiv = document.getElementById("systemLogs");
            logsDiv.innerHTML = logs
              .map((log) => {
                const time = new Date(log.createdAt).toLocaleString();
                const operator = log.get("operator").get("username");
                const content = log.get("content");
                const type = log.get("type");

                // 根据日志类型设置不同的样式
                let typeText = "";
                let typeClass = "";
                switch (type) {
                  case "store_name_fix":
                    typeText = "修复店铺名称";
                    typeClass = "log-fix";
                    break;
                  case "product_extract":
                    typeText = "提取商品";
                    typeClass = "log-extract";
                    break;
                  case "inventory_opening":
                    typeText = "开店盘点";
                    typeClass = "log-inventory";
                    break;
                  case "inventory_closing":
                    typeText = "闭店盘点";
                    typeClass = "log-inventory";
                    break;
                  case "inventory_restocking":
                    typeText = "进货盘点";
                    typeClass = "log-inventory";
                    break;
                  case "inventory_loss":
                    typeText = "报损记录";
                    typeClass = "log-inventory";
                    break;
                }

                return `
                  <div class="log-item ${typeClass}">
                    <div class="log-header">
                      <span class="log-time">${time}</span>
                      <span class="log-operator">${operator}</span>
                      <span class="log-type">${typeText}</span>
                    </div>
                    <div class="log-content">${content}</div>
                  </div>
                `;
              })
              .join("");
          } catch (error) {
            console.error("加载系统日志失败:", error);
          }
        }

        // 添加更新销售数据功能
        async function updateSalesData() {
          try {
            const statusDiv = document.getElementById("importStatus");
            statusDiv.textContent = "正在更新销售数据...";

            // 获取当前日期
            const today = new Date();
            const date = today.toISOString().split("T")[0];

            // 获取店铺信息
            const storeData = JSON.parse(
              localStorage.getItem("selectedStore") || "{}"
            );
            if (!storeData.id) {
              throw new Error("未选择店铺");
            }

            // 获取当天的开店和闭店盘点记录
            const selectedDate = new Date(date);
            selectedDate.setHours(0, 0, 0, 0);
            const nextDay = new Date(selectedDate);
            nextDay.setDate(nextDay.getDate() + 1);

            const InventoryCheck = AV.Object.extend("InventoryCheck");
            const query = new AV.Query(InventoryCheck);
            query.equalTo("storeId", storeData.id);
            query.greaterThanOrEqualTo("date", selectedDate);
            query.lessThan("date", nextDay);
            const inventoryChecks = await query.find();

            // 分类盘点记录
            const openingCheck = inventoryChecks.find(
              (check) => check.get("type") === "opening"
            );
            const closingCheck = inventoryChecks.find(
              (check) => check.get("type") === "closing"
            );
            const restockingChecks = inventoryChecks.filter(
              (check) => check.get("type") === "restocking"
            );
            const lossChecks = inventoryChecks.filter(
              (check) => check.get("type") === "loss"
            );

            if (!openingCheck || !closingCheck) {
              throw new Error("找不到当天的开店或闭店盘点记录");
            }

            // 计算销售数据
            const openingItems = openingCheck.get("items");
            const closingItems = closingCheck.get("items");
            const salesData = [];

            // 获取所有商品信息
            const Product = AV.Object.extend("Product");
            const productQuery = new AV.Query(Product);
            const products = await productQuery.find();
            const productMap = new Map(products.map((p) => [p.id, p]));

            // 处理每个商品
            for (const openingItem of openingItems) {
              const productId = openingItem.product.objectId;
              const product = productMap.get(productId);
              if (!product) continue;

              const closingItem = closingItems.find(
                (item) => item.product.objectId === productId
              );
              if (!closingItem) continue;

              // 计算进货数量
              let restockQuantity = 0;
              restockingChecks.forEach((check) => {
                const restockItem = check
                  .get("items")
                  .find((item) => item.product.objectId === productId);
                if (restockItem) {
                  restockQuantity += restockItem.quantity;
                }
              });

              // 计算报损数量
              let lossQuantity = 0;
              lossChecks.forEach((check) => {
                const lossItem = check
                  .get("items")
                  .find((item) => item.product.objectId === productId);
                if (lossItem) {
                  lossQuantity += lossItem.quantity;
                }
              });

              // 计算销售数量：开店库存 + 进货数量 - 报损数量 - 闭店库存
              const salesQuantity =
                openingItem.quantity +
                restockQuantity -
                lossQuantity -
                closingItem.quantity;

              if (salesQuantity > 0) {
                salesData.push({
                  product: {
                    __type: "Pointer",
                    className: "Product",
                    objectId: productId,
                  },
                  quantity: salesQuantity,
                  productName: product.get("name"),
                  category: product.get("category"),
                  source: product.get("source"),
                  price: product.get("price"),
                });
              }
            }

            // 保存销售数据到 DailyProductSales
            const DailyProductSales = AV.Object.extend("DailyProductSales");
            const salesRecords = salesData.map((sale) => {
              const record = new DailyProductSales();
              record.set("date", selectedDate);
              record.set("storeName", storeData.name);
              record.set("product", sale.product);
              record.set("quantity", sale.quantity);
              record.set("price", sale.price);
              record.set("category", sale.category);
              record.set("source", sale.source);
              record.set("productName", sale.productName);
              return record;
            });

            await AV.Object.saveAll(salesRecords);
            statusDiv.textContent = `销售数据更新成功！共更新 ${salesRecords.length} 条记录`;
          } catch (error) {
            console.error("更新销售数据失败:", error);
            const statusDiv = document.getElementById("importStatus");
            statusDiv.textContent = "更新销售数据失败: " + error.message;
          }
        }

        // 加载店铺列表
        async function loadStores() {
          try {
            console.log("开始加载店铺列表...");
            const currentUser = AV.User.current();
            if (!currentUser) {
              throw new Error("请先登录");
            }

            // 首先尝试从 LeanCloud 获取店铺数据
            const Store = AV.Object.extend("Store");
            const query = new AV.Query("Store");
            const storesList = await query.find();
            console.log("从 LeanCloud 获取的店铺数量:", storesList.length);

            // 如果 LeanCloud 有数据，就使用这些数据
            if (storesList && storesList.length > 0) {
              // 将数据同步到 localStorage
              const stores = {
                direct: [],
                franchise: [],
              };

              storesList.forEach((store) => {
                const storeData = {
                  id: store.get("storeId"),
                  brand: store.get("brand"),
                  name: store.get("name"),
                  type: store.get("type"),
                  address: store.get("address"),
                  status: store.get("status") || "open",
                };

                if (store.get("type") === "direct") {
                  stores.direct.push(storeData);
                } else {
                  stores.franchise.push(storeData);
                }
              });

              // 更新 localStorage
              localStorage.setItem("stores", JSON.stringify(stores));
              console.log("已将店铺数据同步到 localStorage");

              // 渲染店铺列表
              const storesListElement = document.getElementById("storesList");
              storesListElement.innerHTML = storesList
                .map((store) => {
                  const storeType =
                    store.get("type") === "direct" ? "自营店" : "加盟店";
                  const storeName = store.get("name") || "";
                  const displayStoreName = storeName.replace("食圈儿 ", "");
                  return `
                    <tr>
                      <td>${displayStoreName}</td>
                      <td>${storeType}</td>
                      <td>${store.get("address") || ""}</td>
                      <td>${
                        store.get("status") === "open" ? "营业中" : "已打烊"
                      }</td>
                      <td>
                        <div class="action-buttons">
                          <button class="btn btn-primary action-btn" onclick="editStore('${store.get(
                            "storeId"
                          )}')">编辑</button>
                          <button class="btn btn-danger action-btn" onclick="deleteStore('${store.get(
                            "storeId"
                          )}')">删除</button>
                        </div>
                      </td>
                    </tr>
                  `;
                })
                .join("");
            } else {
              // 如果 LeanCloud 没有数据，尝试从 localStorage 获取
              const storesData = localStorage.getItem("stores");
              console.log("从 localStorage 获取的原始数据:", storesData);

              if (!storesData) {
                console.log("没有找到店铺数据");
                document.getElementById("storesList").innerHTML = `
                  <tr>
                    <td colspan="5" style="text-align: center;">暂无店铺数据</td>
                  </tr>
                `;
                return;
              }

              let stores;
              try {
                stores = JSON.parse(storesData);
                console.log("解析后的店铺数据:", stores);

                // 将 localStorage 数据同步到 LeanCloud
                const directStores = stores.direct || [];
                const franchiseStores = stores.franchise || [];

                for (const store of directStores) {
                  const storeObj = new Store();
                  storeObj.set("storeId", store.id);
                  storeObj.set("brand", "食圈儿");
                  storeObj.set("name", store.name);
                  storeObj.set("type", "direct");
                  storeObj.set("address", store.address);
                  storeObj.set("status", store.status || "open");
                  await storeObj.save();
                }

                for (const store of franchiseStores) {
                  const storeObj = new Store();
                  storeObj.set("storeId", store.id);
                  storeObj.set("brand", "食圈儿");
                  storeObj.set("name", store.name);
                  storeObj.set("type", "franchise");
                  storeObj.set("address", store.address);
                  storeObj.set("status", store.status || "open");
                  await storeObj.save();
                }

                // 重新加载店铺列表
                await loadStores();
              } catch (e) {
                console.error("处理店铺数据失败:", e);
                throw new Error("店铺数据处理失败");
              }
            }
          } catch (error) {
            console.error("加载店铺列表失败:", error);
            document.getElementById("storesList").innerHTML = `
              <tr>
                <td colspan="5" style="text-align: center;">加载店铺列表失败: ${error.message}</td>
              </tr>
            `;
            alert("加载店铺列表失败: " + error.message);
          }
        }

        // 页面加载时执行
        window.addEventListener("load", function () {
          loadStores();
        });
      </script>
    </div>
  </body>
</html>
