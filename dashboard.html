<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>食圈儿后台管理系统</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        min-height: 100vh;
        padding: 20px;
      }

      .header {
        background-color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .store-info {
        font-size: 18px;
        font-weight: bold;
        color: #333;
      }

      .container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .card {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #eee;
      }

      .card-title {
        font-size: 18px;
        color: #333;
        font-weight: bold;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-done {
        background-color: #28a745;
      }

      .status-pending {
        background-color: #dc3545;
      }

      .btn {
        padding: 12px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }

      .btn-primary {
        background-color: #007bff;
        color: white;
      }

      .btn-success {
        background-color: #28a745;
        color: white;
      }

      .btn-danger {
        background-color: #dc3545;
        color: white;
      }

      .btn-back {
        background-color: #6c757d;
        color: white;
      }

      .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
      }

      .inventory-status {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .status-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 4px;
      }

      .status-text {
        display: flex;
        align-items: center;
      }

      .status-time {
        color: #666;
        font-size: 14px;
      }

      .alert-card {
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        color: #856404;
        padding: 15px;
        border-radius: 4px;
        margin-top: 10px;
      }

      .statistics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
      }

      .stat-item {
        text-align: center;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 4px;
      }

      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #007bff;
        margin-bottom: 5px;
      }

      .stat-label {
        color: #666;
        font-size: 14px;
      }

      .btn-warning {
        background-color: #ffc107;
        color: #000;
      }

      .btn-warning:hover {
        background-color: #e0a800;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
  </head>
  <body>
    <header class="header">
      <div class="store-info">
        <span id="storeName">正在加载店铺信息...</span>
      </div>
      <div>
        <a href="select-store.html" class="btn btn-back">切换店铺</a>
        <button onclick="logout()" class="btn btn-back">退出登录</button>
      </div>
    </header>

    <div class="container">
      <!-- 今日盘点状态 -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">今日盘点状态</h2>
        </div>
        <div class="inventory-status">
          <div class="status-item">
            <div class="status-text">
              <span class="status-indicator" id="openingStatus"></span>
              开店盘点
            </div>
            <span class="status-time" id="openingTime">未完成</span>
          </div>
          <div class="status-item">
            <div class="status-text">
              <span class="status-indicator" id="restockingStatus"></span>
              进货盘点
            </div>
            <span class="status-time" id="restockingTime">未完成</span>
          </div>
          <div class="status-item">
            <div class="status-text">
              <span class="status-indicator" id="closingStatus"></span>
              闭店盘点
            </div>
            <span class="status-time" id="closingTime">未完成</span>
          </div>
        </div>
        <div style="margin-top: 15px">
          <a
            href="inventory-check.html"
            class="btn btn-primary"
            style="width: 100%"
            >进入盘点页面</a
          >
        </div>
      </div>

      <!-- 库存预警 -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">库存预警</h2>
        </div>
        <div id="alertsList">
          <!-- 将通过 JavaScript 动态填充 -->
        </div>
      </div>

      <!-- 快捷操作 -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">快捷操作</h2>
        </div>
        <div class="quick-actions">
          <a href="products.html" class="btn btn-primary">商品管理</a>
          <a href="inventory-check.html?type=opening" class="btn btn-success"
            >开店盘点</a
          >
          <a href="inventory-check.html?type=restocking" class="btn btn-primary"
            >进货盘点</a
          >
          <a href="inventory-check.html?type=closing" class="btn btn-danger"
            >闭店盘点</a
          >
          <a href="product-loss.html" class="btn btn-warning">商品报损</a>
        </div>
      </div>

      <!-- 今日统计 -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">今日统计</h2>
        </div>
        <div class="statistics">
          <div class="stat-item">
            <div class="stat-value" id="totalProducts">-</div>
            <div class="stat-label">商品总数</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="lowStock">-</div>
            <div class="stat-label">库存预警</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="todayChecks">-</div>
            <div class="stat-label">今日盘点</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // 初始化 LeanCloud
      AV.init({
        appId: "mkIfcbivpuTduCrNfh53VqYV-MdYXbMMI",
        appKey: "e4T5MriHgEYtmK7YPvV64awF",
        serverURL: "https://mkifcbivputducrnfh53vqyv.api.lncldglobal.com",
      });

      // 检查登录状态
      async function checkLogin() {
        const currentUser = AV.User.current();
        if (!currentUser) {
          window.location.href = "index.html";
          return;
        }
        return currentUser;
      }

      // 获取今日盘点状态
      async function getTodayInventoryStatus() {
        try {
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          // 获取当前店铺信息
          const storeData = JSON.parse(
            localStorage.getItem("selectedStore") || "{}"
          );
          if (!storeData.id) {
            console.error("未选择店铺");
            return;
          }

          const query = new AV.Query("InventoryCheck");
          query.greaterThanOrEqualTo("date", today);
          query.lessThan(
            "date",
            new Date(today.getTime() + 24 * 60 * 60 * 1000)
          );
          query.equalTo("storeId", storeData.id); // 添加店铺筛选
          query.include("operator"); // 包含操作员信息
          const checks = await query.find();

          // 重置所有状态为未完成
          document
            .querySelectorAll(".status-indicator")
            .forEach((indicator) => {
              indicator.classList.remove("status-done");
            });
          document.querySelectorAll(".status-time").forEach((time) => {
            time.textContent = "未完成";
          });

          // 更新已完成的盘点状态
          checks.forEach((check) => {
            const type = check.get("type");
            const date = check.get("date");
            const operator = check.get("operator");
            const timeStr = date.toLocaleTimeString();
            const operatorName = operator ? operator.get("name") : "未知";

            document
              .getElementById(`${type}Status`)
              .classList.add("status-done");
            document.getElementById(
              `${type}Time`
            ).textContent = `完成于 ${timeStr} (${operatorName})`;
          });

          document.getElementById("todayChecks").textContent = checks.length;
        } catch (error) {
          console.error("获取盘点状态失败:", error);
        }
      }

      // 获取库存预警
      async function getInventoryAlerts() {
        try {
          const query = new AV.Query("Product");
          const products = await query.find();
          const alerts = [];

          products.forEach((product) => {
            const name = product.get("name");
            // 这里的逻辑后续需要根据实际的库存数据来判断
            // 现在先模拟一些预警
            if (Math.random() < 0.3) {
              alerts.push(`${name} 库存不足`);
            }
          });

          const alertsList = document.getElementById("alertsList");
          if (alerts.length > 0) {
            alertsList.innerHTML = alerts
              .map((alert) => `<div class="alert-card">${alert}</div>`)
              .join("");
          } else {
            alertsList.innerHTML = '<div class="alert-card">暂无库存预警</div>';
          }

          document.getElementById("lowStock").textContent = alerts.length;
        } catch (error) {
          console.error("获取库存预警失败:", error);
        }
      }

      // 获取商品统计
      async function getProductStats() {
        try {
          const query = new AV.Query("Product");
          const count = await query.count();
          document.getElementById("totalProducts").textContent = count;
        } catch (error) {
          console.error("获取商品统计失败:", error);
        }
      }

      // 登出功能
      async function logout() {
        try {
          await AV.User.logOut();
          localStorage.removeItem("user");
          window.location.href = "index.html";
        } catch (error) {
          console.error("登出失败:", error);
          alert("登出失败，请重试");
        }
      }

      // 页面加载时执行
      window.onload = async function () {
        const currentUser = await checkLogin();
        if (!currentUser) return;

        // 设置店铺名称
        const userData = JSON.parse(localStorage.getItem("user") || "{}");
        document.getElementById("storeName").textContent = userData.name
          ? `${userData.name} - 工作台`
          : "工作台";

        // 加载各项数据
        getTodayInventoryStatus();
        getInventoryAlerts();
        getProductStats();
      };
    </script>
  </body>
</html>
