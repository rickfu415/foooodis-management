<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>全店统计 - 食圈儿后台管理系统</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        min-height: 100vh;
        padding: 20px;
      }

      .header {
        background-color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #666;
        font-size: 14px;
      }

      .user-info .name {
        font-weight: bold;
        color: #333;
      }

      .user-info .role {
        background-color: #e9ecef;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
      }

      .btn-back {
        background-color: #6c757d;
        color: white;
      }

      .container {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 20px;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #eee;
      }

      .card-title {
        font-size: 18px;
        color: #333;
        font-weight: bold;
      }

      /* 时间范围选择器样式 */
      .date-range {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 20px;
      }

      .date-range select {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      /* 统计卡片网格布局 */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .stat-title {
        font-size: 16px;
        color: #666;
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #007bff;
        margin-bottom: 5px;
      }

      .stat-amount {
        font-size: 18px;
        color: #28a745;
      }

      .stat-label {
        color: #666;
        font-size: 14px;
      }

      .stat-compare {
        font-size: 14px;
        margin-top: 8px;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 5px;
      }

      .stat-compare.increase {
        color: #28a745;
      }

      .stat-compare.decrease {
        color: #dc3545;
      }

      .stat-compare.increase::before {
        content: "↑";
      }

      .stat-compare.decrease::before {
        content: "↓";
      }

      .stat-compare.no-change {
        color: #6c757d;
      }

      /* 图表容器样式 */
      .chart-container {
        width: 100%;
        height: 400px;
        margin-top: 20px;
      }

      /* 图表工具提示样式 */
      .echarts-tooltip {
        background: rgba(255, 255, 255, 0.9) !important;
        padding: 10px !important;
        border-radius: 4px !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
        border: 1px solid #eee !important;
      }

      .echarts-tooltip-title {
        font-weight: bold;
        margin-bottom: 5px;
        color: #333;
      }

      .echarts-tooltip-item {
        display: flex;
        justify-content: space-between;
        margin: 3px 0;
      }

      /* 添加排行榜样式 */
      .ranking-item {
        display: flex;
        justify-content: space-between;
        padding: 12px;
        border-bottom: 1px solid #eee;
        align-items: center;
      }

      .ranking-item:last-child {
        border-bottom: none;
      }

      .ranking-item .rank {
        width: 30px;
        font-weight: bold;
        color: #333;
      }

      .ranking-item .store-name {
        flex: 1;
        padding: 0 15px;
      }

      .ranking-item .sales {
        width: 120px;
        text-align: right;
        color: #007bff;
        font-weight: bold;
      }

      .ranking-item .orders {
        width: 80px;
        text-align: right;
        color: #666;
        margin-left: 15px;
      }

      .ranking-item .category,
      .ranking-item .source {
        color: #666;
        margin-right: 15px;
      }

      /* 加载状态样式 */
      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      .error-message {
        color: #dc3545;
        text-align: center;
        padding: 10px;
      }

      .empty-message {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      .category-stats,
      .source-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      /* 饼图容器样式 */
      .pie-charts-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .pie-chart {
        height: 300px;
        width: 100%;
      }

      .filter-content {
        display: flex;
        gap: 20px;
        align-items: flex-end;
        padding: 15px;
      }

      .filter-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
        flex: 1;
      }

      .filter-item label {
        font-size: 14px;
        color: #666;
      }

      .filter-select {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        width: 200px;
      }

      .filter-select:hover {
        border-color: #b3b3b3;
      }

      .filter-select:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
      }

      .btn-primary {
        background-color: #007bff;
        color: white;
      }

      .btn-primary:hover {
        background-color: #0056b3;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
  </head>
  <body>
    <header class="header">
      <div class="header-left">
        <a href="select-store.html" class="btn btn-back">返回店铺列表</a>
        <div class="user-info">
          <span class="name" id="userName">-</span>
          <span class="role" id="userRole">-</span>
        </div>
      </div>
    </header>

    <div class="container">
      <!-- 筛选条件 -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">数据筛选</h2>
        </div>
        <div class="filter-content">
          <div class="filter-item">
            <label>时间范围</label>
            <select
              id="timeRange"
              class="filter-select"
              onchange="applyFilters()"
            >
              <option value="today">今日</option>
              <option value="yesterday">昨日</option>
              <option value="last7days">近7天</option>
              <option value="last30days">近30天</option>
              <option value="thisMonth">本月</option>
              <option value="lastMonth">上月</option>
            </select>
          </div>
          <div class="filter-item">
            <label>选择店铺</label>
            <select
              id="storeFilter"
              class="filter-select"
              onchange="applyFilters()"
            >
              <!-- 店铺选项将通过JavaScript动态生成 -->
            </select>
          </div>
        </div>
      </div>

      <!-- 关键指标统计 -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">关键指标</h2>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalSales">-</div>
            <div class="stat-label">总销售额</div>
            <div class="stat-compare" id="totalSalesCompare">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalOrders">-</div>
            <div class="stat-label">总销售量</div>
            <div class="stat-compare" id="totalOrdersCompare">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="avgOrderValue">-</div>
            <div class="stat-label">平均单价</div>
            <div class="stat-compare" id="avgOrderValueCompare">-</div>
          </div>
        </div>
      </div>

      <!-- 销售趋势图表 -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">销售趋势</h2>
        </div>
        <div id="salesTrend" class="chart-container"></div>
      </div>

      <!-- 类别统计 -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">类别统计</h2>
        </div>
        <div class="category-stats">
          <div class="pie-charts-container">
            <div id="categorySalesPie" class="pie-chart"></div>
            <div id="categoryQuantityPie" class="pie-chart"></div>
          </div>
        </div>
      </div>

      <!-- 商品销量排行 -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">商品销量排行</h2>
        </div>
        <div id="productRankings">
          <!-- 商品排行将通过JavaScript动态生成 -->
        </div>
      </div>

      <!-- 店铺排行 -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">店铺销售排行</h2>
        </div>
        <div id="storeRankings">
          <!-- 店铺排行将通过JavaScript动态生成 -->
        </div>
      </div>
    </div>

    <script>
      // 初始化 LeanCloud
      AV.init({
        appId: "mkIfcbivpuTduCrNfh53VqYV-MdYXbMMI",
        appKey: "e4T5MriHgEYtmK7YPvV64awF",
        serverURL: "https://mkifcbivputducrnfh53vqyv.api.lncldglobal.com",
      });

      // 检查用户登录状态
      async function checkLogin() {
        const currentUser = AV.User.current();
        if (!currentUser) {
          window.location.href = "index.html";
          return;
        }

        // 更新用户信息显示
        const userData = JSON.parse(localStorage.getItem("user"));
        if (userData) {
          document.getElementById("userName").textContent =
            userData.name || currentUser.get("username");
          document.getElementById("userRole").textContent =
            userData.role === "admin" ? "管理员" : "店员";
        }

        return currentUser;
      }

      // 工具函数：格式化金额
      function formatCurrency(amount) {
        return new Intl.NumberFormat("zh-CN", {
          style: "currency",
          currency: "CNY",
        }).format(amount);
      }

      // 工具函数：显示加载状态
      function showLoading(elementId) {
        document.getElementById(elementId).innerHTML =
          '<div class="loading">加载中...</div>';
      }

      // 工具函数：显示错误信息
      function showError(elementId, message) {
        document.getElementById(
          elementId
        ).innerHTML = `<div class="error-message">${message}</div>`;
      }

      // 工具函数：显示空数据提示
      function showEmpty(elementId, message) {
        document.getElementById(
          elementId
        ).innerHTML = `<div class="empty-message">${message}</div>`;
      }

      // 获取销售数据
      async function fetchDailyProductSales(timeRange, selectedStore = "all") {
        let query = new AV.Query("DailyProductSales");
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        let startDate, endDate;
        switch (timeRange) {
          case "today":
            startDate = today;
            endDate = new Date(today.getTime() + 24 * 60 * 60 * 1000);
            break;
          case "yesterday":
            startDate = new Date(today.getTime() - 24 * 60 * 60 * 1000);
            endDate = today;
            break;
          case "last7days":
            startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            endDate = new Date(today.getTime() + 24 * 60 * 60 * 1000);
            break;
          case "last30days":
            startDate = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
            endDate = new Date(today.getTime() + 24 * 60 * 60 * 1000);
            break;
          case "thisMonth":
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = new Date(today.getTime() + 24 * 60 * 60 * 1000);
            break;
          case "lastMonth":
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            endDate = new Date(today.getFullYear(), today.getMonth(), 1);
            break;
        }

        query.greaterThanOrEqualTo("date", startDate);
        query.lessThan("date", endDate);

        // 添加店铺筛选
        if (selectedStore !== "all") {
          // 创建两个查询条件：完全匹配和带品牌前缀匹配
          const exactQuery = new AV.Query("DailyProductSales");
          exactQuery.equalTo("storeName", selectedStore);
          exactQuery.greaterThanOrEqualTo("date", startDate);
          exactQuery.lessThan("date", endDate);

          const prefixQuery = new AV.Query("DailyProductSales");
          prefixQuery.equalTo("storeName", "食圈儿 " + selectedStore);
          prefixQuery.greaterThanOrEqualTo("date", startDate);
          prefixQuery.lessThan("date", endDate);

          // 合并两个查询条件（OR）
          query = AV.Query.or(exactQuery, prefixQuery);
        }

        query.select([
          "productName",
          "quantity",
          "storeName",
          "category",
          "date",
        ]);
        query.limit(1000);
        query.addAscending("date");
        return await query.find();
      }

      // 获取商品价格信息
      async function fetchProductPrices() {
        const query = new AV.Query("Product");
        query.select(["name", "price", "category", "source"]);
        query.limit(1000);
        const products = await query.find();

        // 创建商品价格和类别映射
        const productMap = new Map();
        products.forEach((product) => {
          productMap.set(product.get("name"), {
            price: product.get("price") || 0,
            category: product.get("category"),
            source: product.get("source") || "自制", // 默认为自制
          });
        });
        return productMap;
      }

      // 计算统计数据
      async function calculateStatistics(salesData) {
        // 获取商品价格信息
        const productPrices = await fetchProductPrices();

        const stats = {
          totalSales: 0,
          totalOrders: 0,
          avgOrderValue: 0,
          storeRankings: {},
          productRankings: {},
          categoryStats: {
            饮品类: { quantity: 0, amount: 0 },
            烘焙类: { quantity: 0, amount: 0 },
          },
        };

        // 计算总销售额和各种统计
        salesData.forEach((record) => {
          const quantity = record.get("quantity");
          const productName = record.get("productName");
          const storeName = record.get("storeName");

          // 跳过包装袋的统计
          if (productName === "包装袋") {
            return;
          }

          // 从商品映射中获取价格和类别
          const productInfo = productPrices.get(productName) || {
            price: 0,
            category: "未知",
          };
          const amount = quantity * productInfo.price;
          const category = productInfo.category;

          // 累计总销售额和总订单数
          stats.totalSales += amount;
          stats.totalOrders += quantity;

          // 按类别统计
          if (stats.categoryStats[category]) {
            stats.categoryStats[category].quantity += quantity;
            stats.categoryStats[category].amount += amount;
          }

          // 统计店铺销售额
          if (!stats.storeRankings[storeName]) {
            stats.storeRankings[storeName] = {
              totalSales: 0,
              orderCount: 0,
            };
          }
          stats.storeRankings[storeName].totalSales += amount;
          stats.storeRankings[storeName].orderCount += quantity;

          // 统计商品销量
          if (!stats.productRankings[productName]) {
            stats.productRankings[productName] = {
              quantity: 0,
              totalSales: 0,
              category: category,
            };
          }
          stats.productRankings[productName].quantity += quantity;
          stats.productRankings[productName].totalSales += amount;
        });

        // 计算平均客单价
        stats.avgOrderValue =
          stats.totalOrders > 0 ? stats.totalSales / stats.totalOrders : 0;

        return stats;
      }

      // 获取环比数据
      async function fetchComparisonData(timeRange, selectedStore = "all") {
        const currentData = await fetchDailyProductSales(
          timeRange,
          selectedStore
        );
        let previousData;

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        switch (timeRange) {
          case "today":
          case "yesterday":
            previousData = await fetchDailyProductSales(
              "yesterday",
              selectedStore
            );
            break;
          case "last7days":
            const previous7Start = new Date(
              today.getTime() - 14 * 24 * 60 * 60 * 1000
            );
            const previous7End = new Date(
              today.getTime() - 7 * 24 * 60 * 60 * 1000
            );
            const query = new AV.Query("DailyProductSales");
            query.greaterThanOrEqualTo("date", previous7Start);
            query.lessThan("date", previous7End);
            if (selectedStore !== "all") {
              query.equalTo("storeName", selectedStore);
            }
            previousData = await query.find();
            break;
          case "last30days":
            const previous30Start = new Date(
              today.getTime() - 60 * 24 * 60 * 60 * 1000
            );
            const previous30End = new Date(
              today.getTime() - 30 * 24 * 60 * 60 * 1000
            );
            const query30 = new AV.Query("DailyProductSales");
            query30.greaterThanOrEqualTo("date", previous30Start);
            query30.lessThan("date", previous30End);
            if (selectedStore !== "all") {
              query30.equalTo("storeName", selectedStore);
            }
            previousData = await query30.find();
            break;
          case "thisMonth":
            const lastMonthStart = new Date(
              today.getFullYear(),
              today.getMonth() - 1,
              1
            );
            const lastMonthEnd = new Date(
              today.getFullYear(),
              today.getMonth(),
              1
            );
            const queryMonth = new AV.Query("DailyProductSales");
            queryMonth.greaterThanOrEqualTo("date", lastMonthStart);
            queryMonth.lessThan("date", lastMonthEnd);
            if (selectedStore !== "all") {
              queryMonth.equalTo("storeName", selectedStore);
            }
            previousData = await queryMonth.find();
            break;
        }

        const current = await calculateStatistics(currentData);
        const previous = await calculateStatistics(previousData || []);

        return {
          current,
          previous,
          currentData,
          previousData: previousData || [],
        };
      }

      // 计算环比变化
      function calculateComparison(current, previous) {
        if (previous === 0) return current > 0 ? 100 : 0;
        return ((current - previous) / previous) * 100;
      }

      // 格式化环比显示
      function formatComparison(value) {
        const formatted = Math.abs(value).toFixed(1);
        if (value > 0) {
          return `<span class="stat-compare increase">+${formatted}%</span>`;
        } else if (value < 0) {
          return `<span class="stat-compare decrease">${formatted}%</span>`;
        }
        return `<span class="stat-compare no-change">0%</span>`;
      }

      // 初始化销售趋势图表
      function initSalesTrendChart() {
        const chartDom = document.getElementById("salesTrend");
        const myChart = echarts.init(chartDom);
        return myChart;
      }

      // 更新销售趋势图表
      async function updateSalesTrendChart(chart, currentData, previousData) {
        // 获取商品价格信息
        const productPrices = await fetchProductPrices();

        const dates = [];
        const categoryData = {
          "饮品类-自制": {},
          "饮品类-老广": {},
          烘焙类: {},
        };

        // 按日期和类别分组数据
        currentData.forEach((record) => {
          const date = dayjs(record.get("date")).format("YYYY-MM-DD");
          const quantity = record.get("quantity");
          const productName = record.get("productName");

          // 跳过包装袋的统计
          if (productName === "包装袋") {
            return;
          }

          const productInfo = productPrices.get(productName) || {
            category: "未知",
            source: "自制",
          };

          if (!dates.includes(date)) {
            dates.push(date);
          }

          // 处理饮品类的不同来源
          if (productInfo.category === "饮品类") {
            const key =
              productInfo.source === "老广" ? "饮品类-老广" : "饮品类-自制";
            if (!categoryData[key][date]) {
              categoryData[key][date] = 0;
            }
            categoryData[key][date] += quantity;
          }
          // 处理烘焙类
          else if (productInfo.category === "烘焙类") {
            if (!categoryData["烘焙类"][date]) {
              categoryData["烘焙类"][date] = 0;
            }
            categoryData["烘焙类"][date] += quantity;
          }
        });

        // 排序日期
        dates.sort();

        // 生成数据系列
        const series = [
          {
            name: "饮品类-自制",
            type: "bar",
            stack: "drinks",
            data: dates.map((date) => categoryData["饮品类-自制"][date] || 0),
            itemStyle: { color: "#91cc75" }, // 浅绿色
            emphasis: {
              focus: "series",
            },
          },
          {
            name: "饮品类-老广",
            type: "bar",
            stack: "drinks",
            data: dates.map((date) => categoryData["饮品类-老广"][date] || 0),
            itemStyle: { color: "#5470c6" }, // 蓝色
            emphasis: {
              focus: "series",
            },
          },
          {
            name: "烘焙类",
            type: "bar",
            data: dates.map((date) => categoryData["烘焙类"][date] || 0),
            itemStyle: { color: "#fac858" }, // 黄色
            emphasis: {
              focus: "series",
            },
          },
        ];

        const option = {
          tooltip: {
            trigger: "axis",
            className: "echarts-tooltip",
            formatter: function (params) {
              let html = `<div class="echarts-tooltip-title">${params[0].axisValue}</div>`;
              let drinkTotal = 0;

              params.forEach((param) => {
                if (param.value > 0) {
                  html += `<div class="echarts-tooltip-item">
                    <span>${param.seriesName}:</span>
                    <span>${param.value}件</span>
                  </div>`;

                  // 计算饮品类总计
                  if (param.seriesName.startsWith("饮品类")) {
                    drinkTotal += param.value;
                  }
                }
              });

              // 如果有饮品类销售，显示饮品类总计
              if (drinkTotal > 0) {
                html += `<div class="echarts-tooltip-item" style="margin-top:5px;color:#666">
                  <span>饮品类总计:</span>
                  <span>${drinkTotal}件</span>
                </div>`;
              }

              return html;
            },
          },
          legend: {
            data: ["饮品类-自制", "饮品类-老广", "烘焙类"],
            selected: {
              "饮品类-自制": true,
              "饮品类-老广": true,
              烘焙类: true,
            },
          },
          grid: {
            left: "3%",
            right: "4%",
            bottom: "3%",
            containLabel: true,
          },
          xAxis: {
            type: "category",
            data: dates,
            axisLabel: {
              interval: 0,
              rotate: 30,
            },
          },
          yAxis: {
            type: "value",
            name: "销售量",
            axisLabel: {
              formatter: "{value}件",
            },
          },
          series: series,
        };

        chart.setOption(option, true);
      }

      // 更新类别统计饼图
      function updateCategoryPieCharts(stats) {
        // 销售额饼图
        const salesPieChart = echarts.init(
          document.getElementById("categorySalesPie")
        );
        const salesPieOption = {
          title: {
            text: "类别销售额占比",
            left: "center",
          },
          tooltip: {
            trigger: "item",
            formatter: function (params) {
              return `${params.name}<br/>
                     销售额: ${formatCurrency(params.value)}<br/>
                     占比: ${params.percent}%`;
            },
          },
          legend: {
            orient: "horizontal",
            bottom: "bottom",
          },
          series: [
            {
              name: "销售额",
              type: "pie",
              radius: "50%",
              data: Object.entries(stats.categoryStats).map(
                ([category, data]) => ({
                  name: category,
                  value: data.amount,
                })
              ),
              emphasis: {
                itemStyle: {
                  shadowBlur: 10,
                  shadowOffsetX: 0,
                  shadowColor: "rgba(0, 0, 0, 0.5)",
                },
              },
            },
          ],
        };
        salesPieChart.setOption(salesPieOption);

        // 销售量饼图
        const quantityPieChart = echarts.init(
          document.getElementById("categoryQuantityPie")
        );
        const quantityPieOption = {
          title: {
            text: "类别销售量占比",
            left: "center",
          },
          tooltip: {
            trigger: "item",
            formatter: function (params) {
              return `${params.name}<br/>
                     销售量: ${params.value}件<br/>
                     占比: ${params.percent}%`;
            },
          },
          legend: {
            orient: "horizontal",
            bottom: "bottom",
          },
          series: [
            {
              name: "销售量",
              type: "pie",
              radius: "50%",
              data: Object.entries(stats.categoryStats).map(
                ([category, data]) => ({
                  name: category,
                  value: data.quantity,
                })
              ),
              emphasis: {
                itemStyle: {
                  shadowBlur: 10,
                  shadowOffsetX: 0,
                  shadowColor: "rgba(0, 0, 0, 0.5)",
                },
              },
            },
          ],
        };
        quantityPieChart.setOption(quantityPieOption);

        // 监听窗口大小变化
        window.addEventListener("resize", () => {
          salesPieChart.resize();
          quantityPieChart.resize();
        });
      }

      // 更新统计显示
      function updateStatisticsDisplay(stats, compareStats) {
        // 更新关键指标
        document.getElementById("totalSales").textContent = formatCurrency(
          stats.totalSales
        );
        document.getElementById("totalOrders").textContent =
          stats.totalOrders + "件";
        document.getElementById("avgOrderValue").textContent = formatCurrency(
          stats.avgOrderValue
        );

        // 更新环比数据
        if (compareStats) {
          const salesCompare = calculateComparison(
            stats.totalSales,
            compareStats.totalSales
          );
          const ordersCompare = calculateComparison(
            stats.totalOrders,
            compareStats.totalOrders
          );
          const avgValueCompare = calculateComparison(
            stats.avgOrderValue,
            compareStats.avgOrderValue
          );

          document.getElementById("totalSalesCompare").innerHTML =
            formatComparison(salesCompare);
          document.getElementById("totalOrdersCompare").innerHTML =
            formatComparison(ordersCompare);
          document.getElementById("avgOrderValueCompare").innerHTML =
            formatComparison(avgValueCompare);
        }

        // 更新类别统计饼图
        updateCategoryPieCharts(stats);

        // 更新商品排行
        const productRankings = Object.entries(stats.productRankings)
          .sort((a, b) => b[1].quantity - a[1].quantity)
          .slice(0, 20); // 只显示前20名

        if (productRankings.length === 0) {
          showEmpty("productRankings", "暂无商品销售数据");
          return;
        }

        const productRankingsHtml = productRankings
          .map(
            ([product, data], index) => `
            <div class="ranking-item">
              <span class="rank">${index + 1}</span>
              <span class="store-name">${product}</span>
              <span class="category">${data.category}</span>
              <span class="sales">${formatCurrency(data.totalSales)}</span>
              <span class="orders">${data.quantity}件</span>
            </div>
          `
          )
          .join("");

        document.getElementById("productRankings").innerHTML =
          productRankingsHtml;

        // 更新店铺排行
        const storeRankings = Object.entries(stats.storeRankings)
          .map(([store, data]) => ({
            // 统一处理店铺名，去除品牌前缀
            name: store.replace("食圈儿 ", ""),
            ...data,
          }))
          // 合并同名店铺的数据
          .reduce((acc, curr) => {
            const existing = acc.find((item) => item.name === curr.name);
            if (existing) {
              existing.totalSales += curr.totalSales;
              existing.orderCount += curr.orderCount;
            } else {
              acc.push(curr);
            }
            return acc;
          }, [])
          // 按销售额排序
          .sort((a, b) => b.totalSales - a.totalSales);

        if (storeRankings.length === 0) {
          showEmpty("storeRankings", "暂无店铺销售数据");
          return;
        }

        const storeRankingsHtml = storeRankings
          .map(
            (data, index) => `
            <div class="ranking-item">
              <span class="rank">${index + 1}</span>
              <span class="store-name">${data.name}</span>
              <span class="sales">${formatCurrency(data.totalSales)}</span>
              <span class="orders">${data.orderCount}件</span>
            </div>
          `
          )
          .join("");

        document.getElementById("storeRankings").innerHTML = storeRankingsHtml;
      }

      // 更新统计数据
      async function updateStatistics(timeRange, selectedStore = "all") {
        try {
          // 显示加载状态
          showLoading("storeRankings");
          showLoading("productRankings");

          // 获取销售数据和环比数据
          const { current, previous, currentData, previousData } =
            await fetchComparisonData(timeRange, selectedStore);

          // 更新显示
          updateStatisticsDisplay(current, previous);

          // 更新趋势图表
          const chart = initSalesTrendChart();
          await updateSalesTrendChart(chart, currentData, previousData);

          // 监听窗口大小变化，调整图表大小
          window.addEventListener("resize", () => {
            chart.resize();
          });
        } catch (error) {
          console.error("更新统计数据失败:", error);
          showError("storeRankings", "获取店铺数据失败，请重试");
          showError("productRankings", "获取商品数据失败，请重试");
        }
      }

      // 加载店铺列表
      async function loadStoreOptions() {
        try {
          const query = new AV.Query("Store");
          const stores = await query.find();
          const storeFilter = document.getElementById("storeFilter");
          storeFilter.innerHTML = ""; // 清空现有选项

          // 添加"全部店铺"选项
          const allOption = new Option("全部店铺", "all");
          storeFilter.add(allOption);

          // 添加各个店铺选项，存储原始名称但显示简化名称
          stores.forEach((store) => {
            const fullName = store.get("name");
            const displayName = fullName.replace("食圈儿 ", "");
            const option = new Option(displayName, displayName); // 使用简化名称作为值
            storeFilter.add(option);
          });
        } catch (error) {
          console.error("加载店铺列表失败:", error);
        }
      }

      // 应用筛选条件
      async function applyFilters() {
        const timeRange = document.getElementById("timeRange").value;
        const storeFilter = document.getElementById("storeFilter");
        const selectedStore = storeFilter.value;

        // 更新统计数据
        await updateStatistics(timeRange, selectedStore);
      }

      // 页面加载时执行
      window.onload = async function () {
        await checkLogin();
        await loadStoreOptions();
        updateStatistics("today"); // 默认显示今日数据
      };
    </script>
  </body>
</html>
