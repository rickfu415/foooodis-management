<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>全店统计 - 食圈儿后台管理系统</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        min-height: 100vh;
        padding: 20px;
      }

      .header {
        background-color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #666;
        font-size: 14px;
      }

      .user-info .name {
        font-weight: bold;
        color: #333;
      }

      .user-info .role {
        background-color: #e9ecef;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
      }

      .btn-back {
        background-color: #6c757d;
        color: white;
      }

      .container {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 20px;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #eee;
      }

      .card-title {
        font-size: 18px;
        color: #333;
        font-weight: bold;
      }

      /* 时间范围选择器样式 */
      .date-range {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 20px;
      }

      .date-range select {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      /* 统计卡片网格布局 */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .stat-title {
        font-size: 16px;
        color: #666;
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #007bff;
        margin-bottom: 5px;
      }

      .stat-amount {
        font-size: 18px;
        color: #28a745;
      }

      .stat-label {
        color: #666;
        font-size: 14px;
      }

      .stat-compare {
        font-size: 14px;
        margin-top: 8px;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 5px;
      }

      .stat-compare.increase {
        color: #28a745;
      }

      .stat-compare.decrease {
        color: #dc3545;
      }

      .stat-compare.increase::before {
        content: "↑";
      }

      .stat-compare.decrease::before {
        content: "↓";
      }

      .stat-compare.no-change {
        color: #6c757d;
      }

      /* 图表容器样式 */
      .chart-container {
        width: 100%;
        height: 400px;
        margin-top: 20px;
      }

      /* 图表工具提示样式 */
      .echarts-tooltip {
        background: rgba(255, 255, 255, 0.9) !important;
        padding: 10px !important;
        border-radius: 4px !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
        border: 1px solid #eee !important;
      }

      .echarts-tooltip-title {
        font-weight: bold;
        margin-bottom: 5px;
        color: #333;
      }

      .echarts-tooltip-item {
        display: flex;
        justify-content: space-between;
        margin: 3px 0;
      }

      /* 添加排行榜样式 */
      .ranking-item {
        display: flex;
        justify-content: space-between;
        padding: 12px;
        border-bottom: 1px solid #eee;
        align-items: center;
      }

      .ranking-item:last-child {
        border-bottom: none;
      }

      .ranking-item .rank {
        width: 30px;
        font-weight: bold;
        color: #333;
      }

      .ranking-item .store-name {
        flex: 1;
        padding: 0 15px;
      }

      .ranking-item .sales {
        width: 120px;
        text-align: right;
        color: #007bff;
        font-weight: bold;
      }

      .ranking-item .orders {
        width: 80px;
        text-align: right;
        color: #666;
        margin-left: 15px;
      }

      .ranking-item .category,
      .ranking-item .source {
        color: #666;
        margin-right: 15px;
      }

      /* 加载状态样式 */
      .loading {
        position: relative;
      }

      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .error-message {
        color: #dc3545;
        text-align: center;
        padding: 10px;
      }

      .empty-message {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      .category-stats,
      .source-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      /* 饼图容器样式 */
      .pie-charts-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .pie-chart {
        height: 300px;
        width: 100%;
      }

      .filter-content {
        display: flex;
        gap: 20px;
        align-items: flex-end;
        padding: 15px;
      }

      .filter-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
        flex: 1;
      }

      .filter-item label {
        font-size: 14px;
        color: #666;
      }

      .filter-select {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        min-width: 150px;
        background-color: white;
      }

      .filter-select:hover {
        border-color: #b3b3b3;
      }

      .filter-select:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
      }

      .btn-primary {
        background-color: #007bff;
        color: white;
      }

      .btn-primary:hover {
        background-color: #0056b3;
      }

      .time-range-select {
        padding: 6px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        background-color: white;
        cursor: pointer;
      }

      .time-range-select:hover {
        border-color: #999;
      }

      .time-range-select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
      }

      /* 周度销售分析样式 */
      .weekly-controls {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .weekly-stats-container {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }

      .weekly-details {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .weekly-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .summary-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .summary-label {
        font-size: 14px;
        color: #666;
      }

      .summary-value {
        font-size: 18px;
        font-weight: bold;
        color: #333;
      }

      .weekly-product-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 300px;
        overflow-y: auto;
      }

      .product-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
        transition: background-color 0.2s;
      }

      .product-item:hover {
        background: #e9ecef;
      }

      .product-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .product-name {
        font-weight: bold;
        color: #333;
      }

      .product-category {
        font-size: 12px;
        color: #666;
      }

      .product-stats {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 2px;
      }

      .product-quantity {
        font-weight: bold;
        color: #007bff;
      }

      .product-amount {
        font-size: 12px;
        color: #28a745;
      }

      .trend-indicator {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
      }

      .trend-up {
        background-color: #d4edda;
        color: #28a745;
      }

      .trend-down {
        background-color: #f8d7da;
        color: #dc3545;
      }

      .trend-stable {
        background-color: #e9ecef;
        color: #6c757d;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
  </head>
  <body>
    <header class="header">
      <div class="header-left">
        <a href="select-store.html" class="btn btn-back">返回店铺列表</a>
        <div class="user-info">
          <span class="name" id="userName">-</span>
          <span class="role" id="userRole">-</span>
        </div>
      </div>
      <div class="header-right">
        <select
          id="storeFilter"
          class="filter-select"
          onchange="applyFilters()"
        >
          <!-- 店铺选项将通过JavaScript动态生成 -->
        </select>
      </div>
    </header>

    <div class="container">
      <!-- 关键指标 -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">关键指标</h2>
          <select
            class="time-range-select"
            id="keyMetricsTimeRange"
            onchange="updateKeyMetrics()"
          >
            <option value="today">今日</option>
            <option value="yesterday">昨日</option>
            <option value="last7days">近7天</option>
            <option value="last15days" selected>近15天</option>
            <option value="last30days">近30天</option>
            <option value="last3months">近3个月</option>
            <option value="last6months">近6个月</option>
            <option value="allTime">所有时间</option>
          </select>
        </div>
        <div id="keyMetrics" class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalSales">-</div>
            <div class="stat-label">总销售额</div>
            <div class="stat-compare" id="totalSalesCompare">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalOrders">-</div>
            <div class="stat-label">总销售量</div>
            <div class="stat-compare" id="totalOrdersCompare">-</div>
          </div>
        </div>
      </div>

      <!-- 销售趋势图表 -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">销售趋势</h2>
          <select
            class="time-range-select"
            id="salesTrendTimeRange"
            onchange="updateSalesTrend()"
          >
            <option value="today">今日</option>
            <option value="yesterday">昨日</option>
            <option value="last7days">近7天</option>
            <option value="last15days" selected>近15天</option>
            <option value="last30days">近30天</option>
            <option value="last3months">近3个月</option>
            <option value="last6months">近6个月</option>
            <option value="allTime">所有时间</option>
          </select>
        </div>
        <div id="salesTrend" class="chart-container"></div>
      </div>

      <!-- 类别统计 -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">类别统计</h2>
          <select
            class="time-range-select"
            id="categoryStatsTimeRange"
            onchange="updateCategoryStats()"
          >
            <option value="today">今日</option>
            <option value="yesterday">昨日</option>
            <option value="last7days">近7天</option>
            <option value="last15days" selected>近15天</option>
            <option value="last30days">近30天</option>
            <option value="last3months">近3个月</option>
            <option value="last6months">近6个月</option>
            <option value="allTime">所有时间</option>
          </select>
        </div>
        <div class="category-stats">
          <div class="pie-charts-container">
            <div id="categoryQuantityPie" class="pie-chart"></div>
          </div>
        </div>
      </div>

      <!-- 商品排行 -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">商品销量排行</h2>
          <div style="display: flex; gap: 10px; align-items: center">
            <select
              class="time-range-select"
              id="productRankingsTimeRange"
              onchange="updateProductRankings()"
            >
              <option value="today">今日</option>
              <option value="yesterday">昨日</option>
              <option value="last7days">近7天</option>
              <option value="last15days" selected>近15天</option>
              <option value="last30days">近30天</option>
              <option value="last3months">近3个月</option>
              <option value="last6months">近6个月</option>
              <option value="allTime">所有时间</option>
            </select>
            <a
              href="weekly-analysis.html"
              class="btn"
              style="background-color: #007bff; color: white"
              >查看详细分析</a
            >
          </div>
        </div>
        <div id="productRankings">
          <!-- 商品排行将通过JavaScript动态生成 -->
        </div>
      </div>

      <!-- 店铺排行 -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">店铺销售排行</h2>
          <select
            class="time-range-select"
            id="storeRankingsTimeRange"
            onchange="updateStoreRankings()"
          >
            <option value="today">今日</option>
            <option value="yesterday">昨日</option>
            <option value="last7days">近7天</option>
            <option value="last15days" selected>近15天</option>
            <option value="last30days">近30天</option>
            <option value="last3months">近3个月</option>
            <option value="last6months">近6个月</option>
            <option value="allTime">所有时间</option>
          </select>
        </div>
        <div id="storeRankings">
          <!-- 店铺排行将通过JavaScript动态生成 -->
        </div>
      </div>
    </div>

    <script>
      // 初始化 LeanCloud
      AV.init({
        appId: "mkIfcbivpuTduCrNfh53VqYV-MdYXbMMI",
        appKey: "e4T5MriHgEYtmK7YPvV64awF",
        serverURL: "https://mkifcbivputducrnfh53vqyv.api.lncldglobal.com",
      });

      // 检查用户登录状态
      async function checkLogin() {
        const currentUser = AV.User.current();
        if (!currentUser) {
          window.location.href = "index.html";
          return;
        }

        // 更新用户信息显示
        const userData = JSON.parse(localStorage.getItem("user"));
        if (userData) {
          document.getElementById("userName").textContent =
            userData.name || currentUser.get("username");
          document.getElementById("userRole").textContent =
            userData.role === "admin" ? "管理员" : "店员";
        }

        return currentUser;
      }

      // 工具函数：格式化金额
      function formatCurrency(amount) {
        return new Intl.NumberFormat("zh-CN", {
          style: "currency",
          currency: "CNY",
        }).format(amount);
      }

      // 工具函数：显示加载状态
      function showLoading(elementId) {
        const element = document.getElementById(elementId);
        // 保存原有的内容结构，只是添加加载状态的样式
        if (element) {
          element.classList.add("loading");
          if (!element.querySelector(".loading-overlay")) {
            const overlay = document.createElement("div");
            overlay.className = "loading-overlay";
            overlay.innerHTML = '<div class="loading">加载中...</div>';
            element.appendChild(overlay);
          }
        }
      }

      // 工具函数：隐藏加载状态
      function hideLoading(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
          element.classList.remove("loading");
          const overlay = element.querySelector(".loading-overlay");
          if (overlay) {
            overlay.remove();
          }
        }
      }

      // 添加必要的CSS样式
      const style = document.createElement("style");
      style.textContent = `
        .loading {
          position: relative;
        }
        .loading-overlay {
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(255, 255, 255, 0.8);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 1000;
        }
      `;
      document.head.appendChild(style);

      // 工具函数：显示错误信息
      function showError(elementId, message) {
        document.getElementById(
          elementId
        ).innerHTML = `<div class="error-message">${message}</div>`;
      }

      // 工具函数：显示空数据提示
      function showEmpty(elementId, message) {
        document.getElementById(
          elementId
        ).innerHTML = `<div class="empty-message">${message}</div>`;
      }

      // 数据缓存
      const dataCache = {
        sales: new Map(), // 存储销售数据
        products: null, // 存储商品信息
      };

      // 检查缓存是否有效
      function isCacheValid(cacheEntry) {
        return !!(cacheEntry && cacheEntry.data);
      }

      // 生成缓存key
      function generateCacheKey(timeRange, store) {
        return `sales_${timeRange}_${store}`;
      }

      // 获取销售数据（带缓存）
      async function fetchDailyProductSales(timeRange, selectedStore = "all") {
        const cacheKey = generateCacheKey(timeRange, selectedStore);
        const cachedData = dataCache.sales.get(cacheKey);

        // 如果缓存存在且有效，直接返回缓存数据
        if (isCacheValid(cachedData)) {
          console.log("Using cached data for:", cacheKey);
          return cachedData.data;
        }

        // 如果缓存不存在或无效，重新获取数据
        console.log("Fetching fresh data for:", cacheKey);
        let allResults = [];
        let skip = 0;
        const limit = 1000;
        let hasMore = true;

        // 设置日期范围时只考虑年月日
        const today = new Date();
        const todayStr = today.toISOString().split("T")[0];
        today.setHours(0, 0, 0, 0);

        let startDate, endDate;
        switch (timeRange) {
          case "today":
            startDate = new Date(todayStr);
            endDate = new Date(todayStr);
            endDate.setDate(endDate.getDate() + 1);
            break;
          case "yesterday":
            startDate = new Date(todayStr);
            startDate.setDate(startDate.getDate() - 1);
            endDate = new Date(todayStr);
            break;
          case "last7days":
            startDate = new Date(todayStr);
            startDate.setDate(startDate.getDate() - 7);
            endDate = new Date(todayStr);
            endDate.setDate(endDate.getDate() + 1);
            break;
          case "last15days":
            startDate = new Date(todayStr);
            startDate.setDate(startDate.getDate() - 15);
            endDate = new Date(todayStr);
            endDate.setDate(endDate.getDate() + 1);
            break;
          case "last30days":
            startDate = new Date(todayStr);
            startDate.setDate(startDate.getDate() - 30);
            endDate = new Date(todayStr);
            endDate.setDate(endDate.getDate() + 1);
            break;
          case "last3months":
            startDate = new Date(today.getFullYear(), today.getMonth() - 3, 1);
            endDate = new Date(todayStr);
            endDate.setDate(endDate.getDate() + 1);
            break;
          case "last6months":
            startDate = new Date(today.getFullYear(), today.getMonth() - 6, 1);
            endDate = new Date(todayStr);
            endDate.setDate(endDate.getDate() + 1);
            break;
          case "allTime":
            startDate = new Date(2020, 0, 1); // 设置一个足够早的日期
            endDate = new Date(todayStr);
            endDate.setDate(endDate.getDate() + 1);
            break;
        }

        // 确保开始和结束日期都设置为当地时间的0点
        startDate.setHours(0, 0, 0, 0);
        endDate.setHours(0, 0, 0, 0);

        while (hasMore) {
          let query;
          if (selectedStore === "all") {
            query = new AV.Query("DailyProductSales");
          } else {
            // 创建三个查询条件：
            const exactQuery = new AV.Query("DailyProductSales");
            exactQuery.equalTo("storeName", selectedStore);

            const prefixQuery = new AV.Query("DailyProductSales");
            prefixQuery.equalTo("storeName", "食圈儿 " + selectedStore);

            const prefixSpaceQuery = new AV.Query("DailyProductSales");
            prefixSpaceQuery.equalTo("storeName", "食圈儿" + selectedStore);

            query = AV.Query.or(exactQuery, prefixQuery, prefixSpaceQuery);
          }

          query.greaterThanOrEqualTo("date", startDate);
          query.lessThan("date", endDate);
          query.skip(skip);
          query.limit(limit);
          query.addAscending("date");
          query.select(["date", "productName", "storeName", "quantity"]);

          try {
            const results = await query.find();
            allResults = allResults.concat(results);

            if (results.length < limit) {
              hasMore = false;
            } else {
              skip += limit;
            }
          } catch (error) {
            console.error("Batch query failed:", error);
            hasMore = false;
          }
        }

        // 更新缓存
        dataCache.sales.set(cacheKey, {
          data: allResults,
        });

        return allResults;
      }

      // 获取商品信息（带缓存）
      async function fetchProductPrices() {
        // 如果缓存存在，直接返回缓存数据
        if (dataCache.products?.data) {
          console.log("Using cached product data");
          return dataCache.products.data;
        }

        console.log("Fetching fresh product data");
        const query = new AV.Query("Product");
        query.select(["name", "price", "category", "source"]);
        query.limit(1000);
        const products = await query.find();

        // 创建商品信息映射
        const productMap = new Map();
        products.forEach((product) => {
          productMap.set(product.get("name"), {
            price: product.get("price") || 0,
            category: product.get("category"),
            source: product.get("source") || "自制",
          });
        });

        // 更新缓存
        dataCache.products = { data: productMap };

        return productMap;
      }

      // 清除缓存的函数（可以在需要时调用，比如手动刷新数据）
      function clearCache() {
        dataCache.sales.clear();
        dataCache.products = null;
        console.log("Cache cleared");
      }

      // 在筛选条件变化时清除对应的缓存
      function clearSpecificCache(timeRange, store) {
        const cacheKey = generateCacheKey(timeRange, store);
        dataCache.sales.delete(cacheKey);
        console.log("Cleared cache for:", cacheKey);
      }

      // 计算统计数据
      async function calculateStatistics(salesData) {
        // 获取商品信息
        const productInfo = await fetchProductPrices();
        const unmatchedProducts = new Set();

        const stats = {
          totalSales: 0,
          totalOrders: 0,
          avgOrderValue: 0,
          storeRankings: {},
          productRankings: {},
          categoryStats: {
            饮品类: { quantity: 0, amount: 0 },
            烘焙类: { quantity: 0, amount: 0 },
          },
        };

        // 处理每条销售记录
        salesData.forEach((record) => {
          // 从销售记录中提取基础数据
          const date = record.get("date");
          const productName = record.get("productName");
          const storeName = record.get("storeName");
          const quantity = record.get("quantity");

          // 跳过包装袋的统计
          if (productName === "包装袋") {
            return;
          }

          // 从商品信息映射中获取商品详情
          const product = productInfo.get(productName);
          if (!product) {
            unmatchedProducts.add(productName);
            return;
          }

          // 使用商品信息计算销售额
          const amount = quantity * product.price;
          const category = product.category;
          const source = product.source;

          // 累计总销售额和总订单数
          stats.totalSales += amount;
          stats.totalOrders += quantity;

          // 按类别统计
          if (!stats.categoryStats[category]) {
            stats.categoryStats[category] = { quantity: 0, amount: 0 };
          }
          stats.categoryStats[category].quantity += quantity;
          stats.categoryStats[category].amount += amount;

          // 统计店铺销售额
          if (!stats.storeRankings[storeName]) {
            stats.storeRankings[storeName] = {
              totalSales: 0,
              orderCount: 0,
            };
          }
          stats.storeRankings[storeName].totalSales += amount;
          stats.storeRankings[storeName].orderCount += quantity;

          // 统计商品销量
          if (!stats.productRankings[productName]) {
            stats.productRankings[productName] = {
              quantity: 0,
              totalSales: 0,
              category: category,
              source: source,
            };
          }
          stats.productRankings[productName].quantity += quantity;
          stats.productRankings[productName].totalSales += amount;
        });

        // 计算平均客单价
        stats.avgOrderValue =
          stats.totalOrders > 0 ? stats.totalSales / stats.totalOrders : 0;

        // 移除未匹配商品的警告显示
        if (unmatchedProducts.size > 0) {
          console.warn(
            "以下商品在商品列表中未找到对应信息：",
            Array.from(unmatchedProducts).join(", ")
          );
        }

        return stats;
      }

      // 获取环比数据
      async function fetchComparisonData(timeRange, selectedStore = "all") {
        const currentData = await fetchDailyProductSales(
          timeRange,
          selectedStore
        );
        let previousData;

        const today = new Date();
        const todayStr = today.toISOString().split("T")[0];
        today.setHours(0, 0, 0, 0);

        // 创建基础查询条件
        function createBaseQuery(startDate, endDate, store) {
          if (store === "all") {
            const query = new AV.Query("DailyProductSales");
            query.greaterThanOrEqualTo("date", startDate);
            query.lessThan("date", endDate);
            return query;
          } else {
            // 创建三个查询条件：
            // 1. 完全匹配（不带品牌前缀）
            const exactQuery = new AV.Query("DailyProductSales");
            exactQuery.equalTo("storeName", store);
            exactQuery.greaterThanOrEqualTo("date", startDate);
            exactQuery.lessThan("date", endDate);

            // 2. 带品牌前缀匹配
            const prefixQuery = new AV.Query("DailyProductSales");
            prefixQuery.equalTo("storeName", "食圈儿 " + store);
            prefixQuery.greaterThanOrEqualTo("date", startDate);
            prefixQuery.lessThan("date", endDate);

            // 3. 带品牌前缀但有空格变体的匹配
            const prefixSpaceQuery = new AV.Query("DailyProductSales");
            prefixSpaceQuery.equalTo("storeName", "食圈儿" + store);
            prefixSpaceQuery.greaterThanOrEqualTo("date", startDate);
            prefixSpaceQuery.lessThan("date", endDate);

            // 合并三个查询条件（OR）
            return AV.Query.or(exactQuery, prefixQuery, prefixSpaceQuery);
          }
        }

        switch (timeRange) {
          case "today":
          case "yesterday":
            previousData = await fetchDailyProductSales(
              "yesterday",
              selectedStore
            );
            break;
          case "last7days":
            const previous7Start = new Date(todayStr);
            previous7Start.setDate(previous7Start.getDate() - 14);
            const previous7End = new Date(todayStr);
            previous7End.setDate(previous7End.getDate() - 7);

            previous7Start.setHours(0, 0, 0, 0);
            previous7End.setHours(0, 0, 0, 0);

            const query7 = createBaseQuery(
              previous7Start,
              previous7End,
              selectedStore
            );
            previousData = await query7.find();
            break;
          case "last15days":
            const previous15Start = new Date(todayStr);
            previous15Start.setDate(previous15Start.getDate() - 30);
            const previous15End = new Date(todayStr);
            previous15End.setDate(previous15End.getDate() - 15);

            previous15Start.setHours(0, 0, 0, 0);
            previous15End.setHours(0, 0, 0, 0);

            const query15 = createBaseQuery(
              previous15Start,
              previous15End,
              selectedStore
            );
            query15.select(["date", "productName", "storeName", "quantity"]);
            query15.limit(1000);
            previousData = await query15.find();
            break;
          case "last30days":
            // 当前30天的日期范围
            const previous30Start = new Date(todayStr);
            previous30Start.setDate(previous30Start.getDate() - 30);
            const previous30End = new Date(todayStr);
            previous30End.setDate(previous30End.getDate() + 1);

            // 环比数据的日期范围（前一个30天）
            const previous30CompStart = new Date(todayStr);
            previous30CompStart.setDate(previous30CompStart.getDate() - 60);
            const previous30CompEnd = new Date(todayStr);
            previous30CompEnd.setDate(previous30CompEnd.getDate() - 30);

            // 确保时间设置为0点
            previous30CompStart.setHours(0, 0, 0, 0);
            previous30CompEnd.setHours(0, 0, 0, 0);

            // 创建查询并限制返回字段
            const query30 = createBaseQuery(
              previous30CompStart,
              previous30CompEnd,
              selectedStore
            );
            query30.select(["date", "productName", "storeName", "quantity"]);
            query30.limit(1000);
            previousData = await query30.find();
            break;
          case "last3months":
            const previous3MonthsStart = new Date(
              today.getFullYear(),
              today.getMonth() - 3,
              1
            );
            const previous3MonthsEnd = new Date(todayStr);
            previous3MonthsEnd.setDate(previous3MonthsEnd.getDate() + 1);

            const query3Months = createBaseQuery(
              previous3MonthsStart,
              previous3MonthsEnd,
              selectedStore
            );
            query3Months.select([
              "date",
              "productName",
              "storeName",
              "quantity",
            ]);
            query3Months.limit(1000);
            previousData = await query3Months.find();
            break;
          case "last6months":
            const previous6MonthsStart = new Date(
              today.getFullYear(),
              today.getMonth() - 6,
              1
            );
            const previous6MonthsEnd = new Date(todayStr);
            previous6MonthsEnd.setDate(previous6MonthsEnd.getDate() + 1);

            const query6Months = createBaseQuery(
              previous6MonthsStart,
              previous6MonthsEnd,
              selectedStore
            );
            query6Months.select([
              "date",
              "productName",
              "storeName",
              "quantity",
            ]);
            query6Months.limit(1000);
            previousData = await query6Months.find();
            break;
          case "allTime":
            const allTimeStart = new Date(2020, 0, 1);
            const allTimeEnd = new Date(todayStr);
            allTimeEnd.setDate(allTimeEnd.getDate() + 1);

            const queryAllTime = createBaseQuery(
              allTimeStart,
              allTimeEnd,
              selectedStore
            );
            queryAllTime.select([
              "date",
              "productName",
              "storeName",
              "quantity",
            ]);
            queryAllTime.limit(1000);
            previousData = await queryAllTime.find();
            break;
        }

        // 确保所有查询都只选择需要的字段
        if (previousData) {
          previousData = previousData.map((record) => {
            return {
              get: (field) => {
                if (field === "date") return record.get("date");
                if (field === "productName") return record.get("productName");
                if (field === "storeName") return record.get("storeName");
                if (field === "quantity") return record.get("quantity");
                return null;
              },
            };
          });
        }

        const current = await calculateStatistics(currentData);
        const previous = await calculateStatistics(previousData || []);

        return {
          current,
          previous,
          currentData: currentData,
          previousData: previousData || [],
        };
      }

      // 计算环比变化
      function calculateComparison(current, previous) {
        if (previous === 0) return current > 0 ? 100 : 0;
        return ((current - previous) / previous) * 100;
      }

      // 格式化环比显示
      function formatComparison(value) {
        const formatted = Math.abs(value).toFixed(1);
        if (value > 0) {
          return `<span class="stat-compare increase">+${formatted}%</span>`;
        } else if (value < 0) {
          return `<span class="stat-compare decrease">${formatted}%</span>`;
        }
        return `<span class="stat-compare no-change">0%</span>`;
      }

      // 初始化销售趋势图表
      function initSalesTrendChart() {
        const chartDom = document.getElementById("salesTrend");
        const myChart = echarts.init(chartDom);
        return myChart;
      }

      // 更新销售趋势图表
      async function updateSalesTrendChart(chart, currentData, previousData) {
        // 获取商品价格信息
        const productPrices = await fetchProductPrices();

        const dates = [];
        const categoryData = {
          "饮品类-自制": {},
          "饮品类-老广": {},
          烘焙类: {},
        };

        // 按日期和类别分组数据
        currentData.forEach((record) => {
          const date = dayjs(record.get("date")).format("YYYY-MM-DD");
          const quantity = record.get("quantity");
          const productName = record.get("productName");

          // 跳过包装袋的统计
          if (productName === "包装袋") {
            return;
          }

          const productInfo = productPrices.get(productName) || {
            category: "未知",
            source: "自制",
          };

          if (!dates.includes(date)) {
            dates.push(date);
          }

          // 处理饮品类的不同来源
          if (productInfo.category === "饮品类") {
            const key =
              productInfo.source === "老广" ? "饮品类-老广" : "饮品类-自制";
            if (!categoryData[key][date]) {
              categoryData[key][date] = 0;
            }
            categoryData[key][date] += quantity;
          }
          // 处理烘焙类
          else if (productInfo.category === "烘焙类") {
            if (!categoryData["烘焙类"][date]) {
              categoryData["烘焙类"][date] = 0;
            }
            categoryData["烘焙类"][date] += quantity;
          }
        });

        // 排序日期
        dates.sort();

        // 生成数据系列
        const series = [
          {
            name: "饮品类-自制",
            type: "bar",
            stack: "drinks",
            data: dates.map((date) => categoryData["饮品类-自制"][date] || 0),
            itemStyle: { color: "#91cc75" }, // 浅绿色
            emphasis: {
              focus: "series",
            },
          },
          {
            name: "饮品类-老广",
            type: "bar",
            stack: "drinks",
            data: dates.map((date) => categoryData["饮品类-老广"][date] || 0),
            itemStyle: { color: "#5470c6" }, // 蓝色
            emphasis: {
              focus: "series",
            },
          },
          {
            name: "烘焙类",
            type: "bar",
            data: dates.map((date) => categoryData["烘焙类"][date] || 0),
            itemStyle: { color: "#fac858" }, // 黄色
            emphasis: {
              focus: "series",
            },
          },
        ];

        const option = {
          tooltip: {
            trigger: "axis",
            className: "echarts-tooltip",
            formatter: function (params) {
              let html = `<div class="echarts-tooltip-title">${params[0].axisValue}</div>`;
              let drinkTotal = 0;

              params.forEach((param) => {
                if (param.value > 0) {
                  html += `<div class="echarts-tooltip-item">
                    <span>${param.seriesName}:</span>
                    <span>${param.value}件</span>
                  </div>`;

                  // 计算饮品类总计
                  if (param.seriesName.startsWith("饮品类")) {
                    drinkTotal += param.value;
                  }
                }
              });

              // 如果有饮品类销售，显示饮品类总计
              if (drinkTotal > 0) {
                html += `<div class="echarts-tooltip-item" style="margin-top:5px;color:#666">
                  <span>饮品类总计:</span>
                  <span>${drinkTotal}件</span>
                </div>`;
              }

              return html;
            },
          },
          legend: {
            data: ["饮品类-自制", "饮品类-老广", "烘焙类"],
            selected: {
              "饮品类-自制": true,
              "饮品类-老广": true,
              烘焙类: true,
            },
          },
          grid: {
            left: "3%",
            right: "4%",
            bottom: "3%",
            containLabel: true,
          },
          xAxis: {
            type: "category",
            data: dates,
            axisLabel: {
              interval: 0,
              rotate: 30,
            },
          },
          yAxis: {
            type: "value",
            name: "销售量",
            axisLabel: {
              formatter: "{value}件",
            },
          },
          series: series,
        };

        chart.setOption(option, true);
      }

      // 更新类别统计饼图
      function updateCategoryPieCharts(stats) {
        // 销售量饼图
        const quantityPieChart = echarts.init(
          document.getElementById("categoryQuantityPie")
        );
        const quantityPieOption = {
          title: {
            text: "类别销售量占比",
            left: "center",
          },
          tooltip: {
            trigger: "item",
            formatter: function (params) {
              return `${params.name}<br/>
                     销售量: ${params.value}件<br/>
                     占比: ${params.percent}%`;
            },
          },
          legend: {
            orient: "horizontal",
            bottom: "bottom",
          },
          series: [
            {
              name: "销售量",
              type: "pie",
              radius: "50%",
              data: Object.entries(stats.categoryStats).map(
                ([category, data]) => ({
                  name: category,
                  value: data.quantity,
                })
              ),
              emphasis: {
                itemStyle: {
                  shadowBlur: 10,
                  shadowOffsetX: 0,
                  shadowColor: "rgba(0, 0, 0, 0.5)",
                },
              },
            },
          ],
        };
        quantityPieChart.setOption(quantityPieOption);

        // 监听窗口大小变化
        window.addEventListener("resize", () => {
          quantityPieChart.resize();
        });
      }

      // 更新统计显示
      function updateStatisticsDisplay(current, previous) {
        // 检查必需的DOM元素是否存在
        const elements = {
          totalSales: document.getElementById("totalSales"),
          totalSalesCompare: document.getElementById("totalSalesCompare"),
          totalOrders: document.getElementById("totalOrders"),
          totalOrdersCompare: document.getElementById("totalOrdersCompare"),
        };

        // 检查所有必需的元素是否存在
        for (const [key, element] of Object.entries(elements)) {
          if (!element) {
            console.error(`Missing required element: ${key}`);
            return;
          }
        }

        // 更新总销售额
        elements.totalSales.textContent = formatCurrency(current.totalSales);
        elements.totalSalesCompare.innerHTML = formatComparison(
          calculateComparison(current.totalSales, previous.totalSales)
        );

        // 更新总销售量
        elements.totalOrders.textContent = `${current.totalOrders}件`;
        elements.totalOrdersCompare.innerHTML = formatComparison(
          calculateComparison(current.totalOrders, previous.totalOrders)
        );

        // 更新类别统计饼图
        updateCategoryPieCharts(current);

        // 更新商品排行
        const productRankings = Object.entries(current.productRankings)
          .map(([product, data]) => [product, data])
          .sort((a, b) => b[1].totalSales - a[1].totalSales)
          .slice(0, 10);

        if (productRankings.length === 0) {
          showEmpty("productRankings", "暂无商品销售数据");
          return;
        }

        const productRankingsHtml = productRankings
          .map(
            ([product, data], index) => `
            <div class="ranking-item">
              <span class="rank">${index + 1}</span>
              <span class="store-name">${product}</span>
              <span class="category">${data.category}</span>
              <span class="sales">${formatCurrency(data.totalSales)}</span>
              <span class="orders">${data.quantity}件</span>
            </div>
          `
          )
          .join("");

        document.getElementById("productRankings").innerHTML =
          productRankingsHtml;

        // 更新店铺排行
        const storeRankings = Object.entries(current.storeRankings)
          .map(([store, data]) => ({
            // 统一处理店铺名，去除品牌前缀和多余空格
            name: store.replace(/^食圈儿\s*/, "").trim(),
            ...data,
          }))
          // 合并同名店铺的数据
          .reduce((acc, curr) => {
            const existing = acc.find((item) => item.name === curr.name);
            if (existing) {
              existing.totalSales += curr.totalSales;
              existing.orderCount += curr.orderCount;
            } else {
              acc.push(curr);
            }
            return acc;
          }, [])
          // 按销售额排序
          .sort((a, b) => b.totalSales - a.totalSales);

        if (storeRankings.length === 0) {
          showEmpty("storeRankings", "暂无店铺销售数据");
          return;
        }

        const storeRankingsHtml = storeRankings
          .map(
            (data, index) => `
            <div class="ranking-item">
              <span class="rank">${index + 1}</span>
              <span class="store-name">${data.name}</span>
              <span class="sales">${formatCurrency(data.totalSales)}</span>
              <span class="orders">${data.orderCount}件</span>
            </div>
          `
          )
          .join("");

        document.getElementById("storeRankings").innerHTML = storeRankingsHtml;
      }

      // 更新统计数据
      async function updateStatistics(timeRange, selectedStore = "all") {
        try {
          // 显示加载状态
          showLoading("storeRankings");
          showLoading("productRankings");

          // 获取销售数据和环比数据
          const { current, previous, currentData, previousData } =
            await fetchComparisonData(timeRange, selectedStore);

          // 更新显示
          updateStatisticsDisplay(current, previous);

          // 更新趋势图表
          const chart = initSalesTrendChart();
          await updateSalesTrendChart(chart, currentData, previousData);

          // 监听窗口大小变化，调整图表大小
          window.addEventListener("resize", () => {
            chart.resize();
          });
        } catch (error) {
          console.error("更新统计数据失败:", error);
          showError("storeRankings", "获取店铺数据失败，请重试");
          showError("productRankings", "获取商品数据失败，请重试");
        }
      }

      // 加载店铺列表
      async function loadStoreOptions() {
        try {
          const query = new AV.Query("Store");
          const stores = await query.find();
          const storeFilter = document.getElementById("storeFilter");
          storeFilter.innerHTML = ""; // 清空现有选项

          // 添加"全部店铺"选项
          const allOption = new Option("全部店铺", "all");
          storeFilter.add(allOption);

          // 添加各个店铺选项，存储原始名称但显示简化名称
          stores.forEach((store) => {
            const fullName = store.get("name");
            const displayName = fullName.replace("食圈儿 ", "");
            const option = new Option(displayName, displayName); // 使用简化名称作为值
            storeFilter.add(option);
          });
        } catch (error) {
          console.error("加载店铺列表失败:", error);
        }
      }

      // 修改 applyFilters 函数
      async function applyFilters(forceRefresh = false) {
        const timeRange = document.getElementById("timeRange").value;
        const selectedStore = document.getElementById("storeFilter").value;

        if (forceRefresh) {
          clearSpecificCache(timeRange, selectedStore);
        }

        try {
          showLoading("keyMetrics");
          showLoading("storeRankings");
          showLoading("productRankings");

          const data = await fetchComparisonData(timeRange, selectedStore);

          hideLoading("keyMetrics");
          hideLoading("storeRankings");
          hideLoading("productRankings");

          updateStatisticsDisplay(data.current, data.previous);
          const chart = initSalesTrendChart();
          await updateSalesTrendChart(
            chart,
            data.currentData,
            data.previousData
          );
        } catch (error) {
          console.error("更新统计数据失败:", error);
          hideLoading("keyMetrics");
          hideLoading("storeRankings");
          hideLoading("productRankings");
          showError("keyMetrics", "获取数据失败，请重试");
          showError("storeRankings", "获取数据失败，请重试");
          showError("productRankings", "获取数据失败，请重试");
        }
      }

      // 修改日期范围计算函数
      function getDateRange(timeRange) {
        const today = new Date();
        const todayStr = today.toISOString().split("T")[0];
        today.setHours(0, 0, 0, 0);

        let startDate, endDate;

        switch (timeRange) {
          case "today":
            startDate = new Date(todayStr);
            endDate = new Date(todayStr);
            endDate.setDate(endDate.getDate() + 1);
            break;
          case "yesterday":
            startDate = new Date(todayStr);
            startDate.setDate(startDate.getDate() - 1);
            endDate = new Date(todayStr);
            break;
          case "last7days":
            startDate = new Date(todayStr);
            startDate.setDate(startDate.getDate() - 7);
            endDate = new Date(todayStr);
            endDate.setDate(endDate.getDate() + 1);
            break;
          case "last15days":
            startDate = new Date(todayStr);
            startDate.setDate(startDate.getDate() - 15);
            endDate = new Date(todayStr);
            endDate.setDate(endDate.getDate() + 1);
            break;
          case "last30days":
            startDate = new Date(todayStr);
            startDate.setDate(startDate.getDate() - 30);
            endDate = new Date(todayStr);
            endDate.setDate(endDate.getDate() + 1);
            break;
          case "last3months":
            startDate = new Date(today.getFullYear(), today.getMonth() - 3, 1);
            endDate = new Date(todayStr);
            endDate.setDate(endDate.getDate() + 1);
            break;
          case "last6months":
            startDate = new Date(today.getFullYear(), today.getMonth() - 6, 1);
            endDate = new Date(todayStr);
            endDate.setDate(endDate.getDate() + 1);
            break;
          case "allTime":
            startDate = new Date(2020, 0, 1); // 设置一个足够早的日期
            endDate = new Date(todayStr);
            endDate.setDate(endDate.getDate() + 1);
            break;
        }

        return { startDate, endDate };
      }

      // 添加各个模块的更新函数
      async function updateKeyMetrics() {
        const timeRange = document.getElementById("keyMetricsTimeRange").value;
        const selectedStore = document.getElementById("storeFilter").value;
        showLoading("keyMetrics");
        try {
          const data = await fetchComparisonData(timeRange, selectedStore);
          updateStatisticsDisplay(data.current, data.previous);
        } catch (error) {
          console.error("更新关键指标失败:", error);
          showError("keyMetrics", "获取数据失败，请重试");
        } finally {
          hideLoading("keyMetrics");
        }
      }

      async function updateSalesTrend() {
        const timeRange = document.getElementById("salesTrendTimeRange").value;
        const selectedStore = document.getElementById("storeFilter").value;
        showLoading("salesTrend");
        try {
          const data = await fetchComparisonData(timeRange, selectedStore);
          const chart = initSalesTrendChart();
          await updateSalesTrendChart(
            chart,
            data.currentData,
            data.previousData
          );
        } catch (error) {
          console.error("更新销售趋势失败:", error);
          showError("salesTrend", "获取数据失败，请重试");
        } finally {
          hideLoading("salesTrend");
        }
      }

      async function updateCategoryStats() {
        const timeRange = document.getElementById(
          "categoryStatsTimeRange"
        ).value;
        const selectedStore = document.getElementById("storeFilter").value;
        showLoading("categoryQuantityPie");
        try {
          const data = await fetchComparisonData(timeRange, selectedStore);
          updateCategoryPieCharts(data.current);
        } catch (error) {
          console.error("更新类别统计失败:", error);
          showError("categoryQuantityPie", "获取数据失败，请重试");
        } finally {
          hideLoading("categoryQuantityPie");
        }
      }

      async function updateProductRankings() {
        const timeRange = document.getElementById(
          "productRankingsTimeRange"
        ).value;
        const selectedStore = document.getElementById("storeFilter").value;
        showLoading("productRankings");
        try {
          const data = await fetchComparisonData(timeRange, selectedStore);
          updateProductRankingsDisplay(data.current);
        } catch (error) {
          console.error("更新商品排行失败:", error);
          showError("productRankings", "获取数据失败，请重试");
        } finally {
          hideLoading("productRankings");
        }
      }

      async function updateStoreRankings() {
        const timeRange = document.getElementById(
          "storeRankingsTimeRange"
        ).value;
        const selectedStore = document.getElementById("storeFilter").value;
        showLoading("storeRankings");
        try {
          const data = await fetchComparisonData(timeRange, selectedStore);
          updateStoreRankingsDisplay(data.current);
        } catch (error) {
          console.error("更新店铺排行失败:", error);
          showError("storeRankings", "获取数据失败，请重试");
        } finally {
          hideLoading("storeRankings");
        }
      }

      // 添加店铺排行显示函数
      function updateStoreRankingsDisplay(stats) {
        // 获取店铺排行数据
        const storeRankings = Object.entries(stats.storeRankings)
          .map(([store, data]) => ({
            // 统一处理店铺名，去除品牌前缀和多余空格
            name: store.replace(/^食圈儿\s*/, "").trim(),
            ...data,
          }))
          // 合并同名店铺的数据
          .reduce((acc, curr) => {
            const existing = acc.find((item) => item.name === curr.name);
            if (existing) {
              existing.totalSales += curr.totalSales;
              existing.orderCount += curr.orderCount;
            } else {
              acc.push(curr);
            }
            return acc;
          }, [])
          // 按销售额排序
          .sort((a, b) => b.totalSales - a.totalSales);

        if (storeRankings.length === 0) {
          showEmpty("storeRankings", "暂无店铺销售数据");
          return;
        }

        const storeRankingsHtml = storeRankings
          .map(
            (data, index) => `
            <div class="ranking-item">
              <span class="rank">${index + 1}</span>
              <span class="store-name">${data.name}</span>
              <span class="sales">${formatCurrency(data.totalSales)}</span>
              <span class="orders">${data.orderCount}件</span>
            </div>
          `
          )
          .join("");

        document.getElementById("storeRankings").innerHTML = storeRankingsHtml;
      }

      // 添加商品排行显示函数
      function updateProductRankingsDisplay(stats) {
        const productRankings = Object.entries(stats.productRankings)
          .map(([product, data]) => [product, data])
          .sort((a, b) => b[1].totalSales - a[1].totalSales)
          .slice(0, 10);

        if (productRankings.length === 0) {
          showEmpty("productRankings", "暂无商品销售数据");
          return;
        }

        const productRankingsHtml = productRankings
          .map(
            ([product, data], index) => `
            <div class="ranking-item">
              <span class="rank">${index + 1}</span>
              <span class="store-name">${product}</span>
              <span class="category">${data.category}</span>
              <span class="sales">${formatCurrency(data.totalSales)}</span>
              <span class="orders">${data.quantity}件</span>
            </div>
          `
          )
          .join("");

        document.getElementById("productRankings").innerHTML =
          productRankingsHtml;
      }

      // 修改页面加载函数
      window.onload = async function () {
        await checkLogin();
        await loadStoreOptions();

        // 加载所有模块数据
        await Promise.all([
          updateKeyMetrics(),
          updateSalesTrend(),
          updateCategoryStats(),
          updateProductRankings(),
          updateStoreRankings(),
        ]);
      };
    </script>
  </body>
</html>
